<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>THE SONGA - Library Admin</title>
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet">
    
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #D4AF37;
            --primary-light: #F5E6B3;
            --primary-dark: #B8860B;
            --secondary: #000000;
            --secondary-light: #333333;
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-sidebar: #1e293b;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-light: #94a3b8;
            --border: #e2e8f0;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius-sm: 0.375rem;
            --radius: 0.5rem;
            --radius-lg: 0.75rem;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            overflow-x: hidden;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            background: var(--bg-sidebar);
            color: white;
            position: sticky;
            top: 0;
            height: 100vh;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            z-index: 50;
        }

        .sidebar-header {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.25rem;
        }

        .logo-text {
            font-weight: 700;
            font-size: 1.25rem;
            letter-spacing: -0.025em;
        }

        .logo-subtext {
            font-size: 0.75rem;
            color: var(--text-light);
            opacity: 0.7;
            margin-top: 0.125rem;
        }

        .nav-section {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-light);
            margin-bottom: 1rem;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: var(--text-light);
            text-decoration: none;
            border-radius: var(--radius);
            transition: var(--transition);
            font-weight: 500;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .nav-link.active {
            background: var(--primary);
            color: var(--secondary);
            font-weight: 600;
        }

        .nav-link .material-icons-sharp {
            font-size: 1.25rem;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-footer {
            margin-top: auto;
            padding: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--secondary);
        }

        .user-info h4 {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .user-info p {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            padding: 2rem;
            overflow-y: auto;
            max-height: 100vh;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .header-title h1 {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.025em;
        }

        .header-title p {
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding: 0.75rem 1rem 0.75rem 3rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            width: 300px;
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        .search-box .material-icons-sharp {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            border: none;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--secondary);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-primary);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        /* ===== STATS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .stat-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-light);
            color: var(--primary);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        .stat-change {
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .stat-change.positive {
            color: var(--success);
        }

        .stat-change.negative {
            color: var(--danger);
        }

        /* ===== CHARTS ===== */
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* ===== DATA TABLES ===== */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .data-table-container {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: var(--bg-primary);
            padding: 1rem 1.5rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border);
        }

        .data-table td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }

        .data-table tr:hover {
            background: var(--bg-primary);
        }

        /* ===== STATUS BADGES ===== */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-available {
            background: #d1fae5;
            color: var(--success);
        }

        .status-borrowed {
            background: #fef3c7;
            color: var(--warning);
        }

        .status-overdue {
            background: #fee2e2;
            color: var(--danger);
        }

        .status-reserved {
            background: #e0f2fe;
            color: var(--info);
        }

        .status-returned {
            background: #d1fae5;
            color: var(--success);
        }

        .status-active {
            background: #d1fae5;
            color: var(--success);
        }

        .status-pending {
            background: #fef3c7;
            color: var(--warning);
        }

        .status-suspended {
            background: #fee2e2;
            color: var(--danger);
        }

        .tier-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius);
            font-size: 0.75rem;
            font-weight: 600;
        }

        .tier-explorer {
            background: #e0f2fe;
            color: #0369a1;
        }

        .tier-scholar {
            background: #f0f9ff;
            color: #0c4a6e;
        }

        .tier-visionary {
            background: var(--primary-light);
            color: var(--primary-dark);
        }

        /* ===== ACTION BUTTONS ===== */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            background: transparent;
            color: var(--text-secondary);
        }

        .btn-icon:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .btn-icon.edit:hover {
            background: #dbeafe;
            color: var(--info);
        }

        .btn-icon.delete:hover {
            background: #fee2e2;
            color: var(--danger);
        }

        /* ===== FORMS ===== */
        .form-container {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
        }

        .form-section {
            margin-bottom: 2rem;
        }

        .form-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.875rem;
            transition: var(--transition);
            background: var(--bg-primary);
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        /* ===== MODALS ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }

        .modal-lg {
            max-width: 800px;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: var(--bg-primary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* ===== UTILITIES ===== */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state .material-icons-sharp {
            font-size: 3rem;
            color: var(--text-light);
            margin-bottom: 1rem;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            color: var(--text-secondary);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .alert {
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .alert-success {
            background: #d1fae5;
            color: var(--success);
            border: 1px solid #a7f3d0;
        }

        .alert-error {
            background: #fee2e2;
            color: var(--danger);
            border: 1px solid #fecaca;
        }

        .alert-warning {
            background: #fef3c7;
            color: var(--warning);
            border: 1px solid #fde68a;
        }

        /* ===== TABS ===== */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 2rem;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            position: relative;
            transition: var(--transition);
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .tab.active {
            color: var(--primary);
            font-weight: 600;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ===== BOOK GRID ===== */
        .books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .book-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid var(--border);
        }

        .book-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .book-cover {
            width: 100%;
            height: 180px;
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            color: var(--secondary);
            font-size: 2.5rem;
            overflow: hidden;
        }

        .book-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .book-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            line-height: 1.3;
        }

        .book-author {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .book-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .book-rating {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            color: var(--warning);
        }

        .category-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius);
            font-size: 0.75rem;
            font-weight: 600;
            background: var(--primary-light);
            color: var(--primary-dark);
        }

        /* ===== FILTER BAR ===== */
        .filter-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            flex-wrap: wrap;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: none;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .search-box input {
                width: 200px;
            }
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .header-actions {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            
            .search-box input {
                width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .data-table {
                display: block;
                overflow-x: auto;
            }
            
            .filter-bar {
                flex-direction: column;
            }
            
            .tabs {
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .books-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }

        /* ===== DARK MODE ===== */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #0f172a;
                --bg-secondary: #1e293b;
                --text-primary: #f1f5f9;
                --text-secondary: #cbd5e1;
                --text-light: #64748b;
                --border: #334155;
            }
            
            .stat-card, .chart-card, .data-table-container, .form-container, .book-card {
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
            }
            
            .search-box input, .form-input, .form-select, .form-textarea {
                background: #1e293b;
                border-color: #334155;
                color: #f1f5f9;
            }
        }

        /* ===== QUICK ACTIONS ===== */
        .quick-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .quick-action-card {
            flex: 1;
            min-width: 200px;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .quick-action-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .quick-action-icon {
            width: 60px;
            height: 60px;
            border-radius: var(--radius);
            background: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 1.5rem;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">TS</div>
                    <div>
                        <div class="logo-text">THE SONGA</div>
                        <div class="logo-subtext">Library Admin</div>
                    </div>
                </div>
            </div>
            
            <div class="nav-section">
                <h3 class="nav-title">Library Management</h3>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="#overview" class="nav-link active" data-section="overview">
                            <span class="material-icons-sharp">dashboard</span>
                            <span>Overview</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#books" class="nav-link" data-section="books">
                            <span class="material-icons-sharp">library_books</span>
                            <span>Books</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#borrow" class="nav-link" data-section="borrow">
                            <span class="material-icons-sharp">bookmark</span>
                            <span>Borrow</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#returns" class="nav-link" data-section="returns">
                            <span class="material-icons-sharp">assignment_return</span>
                            <span>Returns & Fines</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#users" class="nav-link" data-section="users">
                            <span class="material-icons-sharp">people</span>
                            <span>Users</span>
                        </a>
                    </li>
                </ul>
            </div>
            
            <div class="nav-section">
                <h3 class="nav-title">Management</h3>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="#categories" class="nav-link" data-section="categories">
                            <span class="material-icons-sharp">category</span>
                            <span>Categories</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#reports" class="nav-link" data-section="reports">
                            <span class="material-icons-sharp">analytics</span>
                            <span>Reports</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#settings" class="nav-link" data-section="settings">
                            <span class="material-icons-sharp">settings</span>
                            <span>Settings</span>
                        </a>
                    </li>
                </ul>
            </div>
            
            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar" id="adminAvatar">LA</div>
                    <div class="user-info">
                        <h4 id="adminName">Library Admin</h4>
                        <p id="adminEmail">admin@thesongawelfare.com</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-title">
                    <h1 id="pageTitle">Library Overview</h1>
                    <p id="pageSubtitle">Manage your library inventory and borrowings</p>
                </div>
                <div class="header-actions">
                    <div class="search-box">
                        <span class="material-icons-sharp">search</span>
                        <input type="text" placeholder="Search..." id="globalSearch">
                    </div>
                    <button class="btn btn-secondary" id="refreshBtn">
                        <span class="material-icons-sharp">refresh</span>
                        Refresh
                    </button>
                </div>
            </header>

            <!-- Alert Container -->
            <div id="alertContainer"></div>

            <!-- Content Container -->
            <div id="contentContainer">
                <!-- Content will be loaded here -->
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="modalOverlay">
        <!-- Modals will be injected here -->
    </div>

    <!-- Templates -->
    <template id="overviewTemplate">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-title">Total Books</div>
                        <div class="stat-value" id="totalBooks">0</div>
                    </div>
                    <div class="stat-icon">
                        <span class="material-icons-sharp">library_books</span>
                    </div>
                </div>
                <div class="stat-change positive">
                    <span class="material-icons-sharp">trending_up</span>
                    <span id="booksChange">0% from last month</span>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-title">Available Books</div>
                        <div class="stat-value" id="availableBooks">0</div>
                    </div>
                    <div class="stat-icon">
                        <span class="material-icons-sharp">check_circle</span>
                    </div>
                </div>
                <div class="stat-change" id="availableChange">
                    <span class="material-icons-sharp">trending_up</span>
                    <span>0% available</span>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-title">Borrowed Books</div>
                        <div class="stat-value" id="borrowedBooks">0</div>
                    </div>
                    <div class="stat-icon">
                        <span class="material-icons-sharp">bookmark</span>
                    </div>
                </div>
                <div class="stat-change" id="borrowedChange">
                    <span class="material-icons-sharp">trending_up</span>
                    <span>0 active borrows</span>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-title">Overdue Books</div>
                        <div class="stat-value" id="overdueBooks">0</div>
                    </div>
                    <div class="stat-icon">
                        <span class="material-icons-sharp">warning</span>
                    </div>
                </div>
                <div class="stat-change negative" id="overdueChange">
                    <span class="material-icons-sharp">trending_up</span>
                    <span>0 need attention</span>
                </div>
            </div>
        </div>

        <div class="quick-actions">
            <div class="quick-action-card" onclick="showAddBookModal()">
                <div class="quick-action-icon">
                    <span class="material-icons-sharp">add</span>
                </div>
                <div>
                    <h3 style="font-size: 1rem; margin-bottom: 0.25rem;">Add New Book</h3>
                    <p style="font-size: 0.875rem; color: var(--text-secondary);">Add books to library</p>
                </div>
            </div>
            <div class="quick-action-card" onclick="showBorrowBookModal()">
                <div class="quick-action-icon">
                    <span class="material-icons-sharp">bookmark_add</span>
                </div>
                <div>
                    <h3 style="font-size: 1rem; margin-bottom: 0.25rem;">New Borrow</h3>
                    <p style="font-size: 0.875rem; color: var(--text-secondary);">Process book borrowing</p>
                </div>
            </div>
            <div class="quick-action-card" onclick="showReturnBookModal()">
                <div class="quick-action-icon">
                    <span class="material-icons-sharp">assignment_return</span>
                </div>
                <div>
                    <h3 style="font-size: 1rem; margin-bottom: 0.25rem;">Return Book</h3>
                    <p style="font-size: 0.875rem; color: var(--text-secondary);">Process book returns</p>
                </div>
            </div>
            <div class="quick-action-card" onclick="showGenerateReportModal()">
                <div class="quick-action-icon">
                    <span class="material-icons-sharp">description</span>
                </div>
                <div>
                    <h3 style="font-size: 1rem; margin-bottom: 0.25rem;">Generate Report</h3>
                    <p style="font-size: 0.875rem; color: var(--text-secondary);">Generate library report</p>
                </div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Monthly Borrowing Activity</h3>
                    <select class="form-select" style="width: auto; padding: 0.5rem;" id="monthSelect">
                        <option value="30">Last 30 days</option>
                        <option value="90">Last 90 days</option>
                        <option value="180">Last 6 months</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="borrowingChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Top Categories</h3>
                </div>
                <div class="chart-container">
                    <canvas id="categoriesChart"></canvas>
                </div>
            </div>
        </div>

        <div class="section-header">
            <h2 class="section-title">Recent Borrowings</h2>
            <button class="btn btn-secondary" onclick="loadSection('borrow')">
                View All
            </button>
        </div>
        
        <div class="data-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Book</th>
                        <th>Borrower</th>
                        <th>Borrowed Date</th>
                        <th>Due Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="recentBorrowingsBody">
                    <!-- Will be populated -->
                </tbody>
            </table>
        </div>

        <div class="section-header" style="margin-top: 3rem;">
            <h2 class="section-title">Recently Added Books</h2>
            <button class="btn btn-secondary" onclick="loadSection('books')">
                View All
            </button>
        </div>
        
        <div class="books-grid" id="recentBooksGrid">
            <!-- Will be populated -->
        </div>
    </template>

    <template id="booksTemplate">
        <div class="section-header">
            <h2 class="section-title">Book Management</h2>
            <div class="header-actions">
                <div class="search-box">
                    <span class="material-icons-sharp">search</span>
                    <input type="text" placeholder="Search books..." id="bookSearch">
                </div>
                <button class="btn btn-secondary" onclick="exportBooks()">
                    <span class="material-icons-sharp">download</span>
                    Export
                </button>
                <button class="btn btn-primary" onclick="showAddBookModal()">
                    <span class="material-icons-sharp">add</span>
                    Add Book
                </button>
            </div>
        </div>

        <div class="filter-bar">
            <select class="form-select" id="bookFilter" style="width: 200px;">
                <option value="all">All Books</option>
                <option value="available">Available</option>
                <option value="borrowed">Borrowed</option>
                <option value="reserved">Reserved</option>
                <option value="featured">Featured</option>
            </select>
            <select class="form-select" id="categoryFilter" style="width: 200px;">
                <option value="all">All Categories</option>
                <!-- Categories will be populated -->
            </select>
            <select class="form-select" id="sortFilter" style="width: 200px;">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="title">Title A-Z</option>
                <option value="author">Author A-Z</option>
                <option value="popular">Most Popular</option>
            </select>
            <button class="btn btn-sm btn-secondary" onclick="clearFilters()">
                Clear Filters
            </button>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="gridView">Grid View</button>
            <button class="tab" data-tab="tableView">Table View</button>
        </div>

        <div class="tab-content active" id="gridView">
            <div class="books-grid" id="booksGrid">
                <!-- Will be populated -->
            </div>
        </div>

        <div class="tab-content" id="tableView">
            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Book Details</th>
                            <th>Category</th>
                            <th>Copies</th>
                            <th>Available</th>
                            <th>Borrow Count</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="booksTableBody">
                        <!-- Will be populated -->
                    </tbody>
                </table>
            </div>
        </div>
    </template>

    <template id="bookCardTemplate">
        <div class="book-card" data-book-id="{id}">
            <div class="book-cover">
                {coverImage ? '<img src="{coverImage}" alt="{title}">' : '<span class="material-icons-sharp">menu_book</span>'}
            </div>
            <h3 class="book-title">{title}</h3>
            <p class="book-author">{author}</p>
            <div class="book-meta">
                <div class="book-rating">
                    <span class="material-icons-sharp">star</span>
                    <span>{rating}</span>
                </div>
                <span class="category-badge">{category}</span>
            </div>
            <div class="book-meta">
                <span>Copies: {availableCopies}/{totalCopies}</span>
                <span class="status-badge status-{availability}">{availability}</span>
            </div>
            <div class="action-buttons" style="margin-top: 1rem;">
                <button class="btn-icon" onclick="viewBook('{id}')" title="View">
                    <span class="material-icons-sharp">visibility</span>
                </button>
                <button class="btn-icon edit" onclick="editBook('{id}')" title="Edit">
                    <span class="material-icons-sharp">edit</span>
                </button>
                <button class="btn-icon delete" onclick="deleteBook('{id}')" title="Delete">
                    <span class="material-icons-sharp">delete</span>
                </button>
                {availableCopies > 0 ? '<button class="btn-icon" onclick="showBorrowBookModal(\'{id}\')" title="Borrow"><span class="material-icons-sharp">bookmark</span></button>' : ''}
            </div>
        </div>
    </template>

    <template id="borrowTemplate">
        <div class="section-header">
            <h2 class="section-title">Borrow Management</h2>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="showBorrowBookModal()">
                    <span class="material-icons-sharp">bookmark_add</span>
                    New Borrow
                </button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="activeBorrows">Active Borrows</button>
            <button class="tab" data-tab="overdueBorrows">Overdue</button>
            <button class="tab" data-tab="borrowHistory">History</button>
        </div>

        <div class="tab-content active" id="activeBorrows">
            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Book</th>
                            <th>Borrower</th>
                            <th>Borrow Date</th>
                            <th>Due Date</th>
                            <th>Days Left</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="activeBorrowsBody">
                        <!-- Will be populated -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-content" id="overdueBorrows">
            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Book</th>
                            <th>Borrower</th>
                            <th>Due Date</th>
                            <th>Days Overdue</th>
                            <th>Fine Amount</th>
                            <th>Contact</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="overdueBorrowsBody">
                        <!-- Will be populated -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-content" id="borrowHistory">
            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Book</th>
                            <th>Borrower</th>
                            <th>Borrow Date</th>
                            <th>Return Date</th>
                            <th>Duration</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="borrowHistoryBody">
                        <!-- Will be populated -->
                    </tbody>
                </table>
            </div>
        </div>
    </template>

    <template id="returnsTemplate">
        <div class="section-header">
            <h2 class="section-title">Returns & Fines Management</h2>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-title">Pending Returns</div>
                        <div class="stat-value" id="pendingReturns">0</div>
                    </div>
                    <div class="stat-icon">
                        <span class="material-icons-sharp">pending</span>
                    </div>
                </div>
                <div class="stat-change" id="pendingReturnsChange">
                    <span class="material-icons-sharp">trending_up</span>
                    <span>0 awaiting return</span>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-title">Total Fines</div>
                        <div class="stat-value" id="totalFines">KSh 0</div>
                    </div>
                    <div class="stat-icon">
                        <span class="material-icons-sharp">monetization_on</span>
                    </div>
                </div>
                <div class="stat-change" id="totalFinesChange">
                    <span class="material-icons-sharp">trending_up</span>
                    <span>0 unpaid</span>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-title">Paid Fines</div>
                        <div class="stat-value" id="paidFines">KSh 0</div>
                    </div>
                    <div class="stat-icon">
                        <span class="material-icons-sharp">check_circle</span>
                    </div>
                </div>
                <div class="stat-change positive" id="paidFinesChange">
                    <span class="material-icons-sharp">trending_up</span>
                    <span>0 collected</span>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="returnsList">Returns List</button>
            <button class="tab" data-tab="finesList">Fines List</button>
        </div>

        <div class="tab-content active" id="returnsList">
            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Book</th>
                            <th>Borrower</th>
                            <th>Return Date</th>
                            <th>Days Overdue</th>
                            <th>Fine</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="returnsTableBody">
                        <!-- Will be populated -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-content" id="finesList">
            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Book</th>
                            <th>Due Date</th>
                            <th>Days Overdue</th>
                            <th>Fine Amount</th>
                            <th>Payment Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="finesTableBody">
                        <!-- Will be populated -->
                    </tbody>
                </table>
            </div>
        </div>
    </template>

    <template id="usersTemplate">
        <div class="section-header">
            <h2 class="section-title">Library Users</h2>
            <div class="header-actions">
                <div class="search-box">
                    <span class="material-icons-sharp">search</span>
                    <input type="text" placeholder="Search users..." id="userSearch">
                </div>
                <button class="btn btn-secondary" onclick="exportUsers()">
                    <span class="material-icons-sharp">download</span>
                    Export Users
                </button>
            </div>
        </div>

        <div class="filter-bar">
            <select class="form-select" id="userFilter" style="width: 200px;">
                <option value="all">All Users</option>
                <option value="active">Active</option>
                <option value="overdue">With Overdue</option>
                <option value="fines">With Fines</option>
            </select>
            <select class="form-select" id="userTierFilter" style="width: 200px;">
                <option value="all">All Tiers</option>
                <option value="explorer">Explorer</option>
                <option value="scholar">Scholar</option>
                <option value="visionary">Visionary</option>
            </select>
        </div>

        <div class="data-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Membership</th>
                        <th>Borrowed Books</th>
                        <th>Overdue</th>
                        <th>Total Fines</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="libraryUsersBody">
                    <!-- Will be populated -->
                </tbody>
            </table>
        </div>
    </template>

    <template id="categoriesTemplate">
        <div class="section-header">
            <h2 class="section-title">Book Categories</h2>
            <button class="btn btn-primary" onclick="showAddCategoryModal()">
                <span class="material-icons-sharp">add</span>
                Add Category
            </button>
        </div>

        <div class="books-grid" id="categoriesGrid">
            <!-- Will be populated -->
        </div>
    </template>

    <template id="reportsTemplate">
        <div class="section-header">
            <h2 class="section-title">Library Reports</h2>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="generateMonthlyReport()">
                    <span class="material-icons-sharp">download</span>
                    Monthly Report
                </button>
                <button class="btn btn-primary" onclick="generateFullReport()">
                    <span class="material-icons-sharp">description</span>
                    Full Report
                </button>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Monthly Statistics</h3>
                    <select class="form-select" style="width: auto; padding: 0.5rem;" id="reportPeriod">
                        <option value="30">Last 30 days</option>
                        <option value="90">Last 90 days</option>
                        <option value="180">Last 6 months</option>
                        <option value="365">Last Year</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="monthlyStatsChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Top Borrowers</h3>
                </div>
                <div class="chart-container">
                    <canvas id="topBorrowersChart"></canvas>
                </div>
            </div>
        </div>

        <div class="section-header">
            <h3 class="section-title">Detailed Statistics</h3>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-title">Most Borrowed Book</div>
                        <div class="stat-value" id="mostBorrowedBook">-</div>
                    </div>
                </div>
                <div class="stat-change" id="mostBorrowedBookChange">
                    <span>0 borrows</span>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-title">Average Borrow Duration</div>
                        <div class="stat-value" id="avgBorrowDuration">0 days</div>
                    </div>
                </div>
                <div class="stat-change" id="avgBorrowDurationChange">
                    <span>Average return time</span>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-title">Busiest Day</div>
                        <div class="stat-value" id="busiestDay">-</div>
                    </div>
                </div>
                <div class="stat-change" id="busiestDayChange">
                    <span>0 borrows</span>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-title">Total Revenue</div>
                        <div class="stat-value" id="totalRevenue">KSh 0</div>
                    </div>
                </div>
                <div class="stat-change positive" id="totalRevenueChange">
                    <span class="material-icons-sharp">trending_up</span>
                    <span>From fines</span>
                </div>
            </div>
        </div>
    </template>

    <template id="settingsTemplate">
        <div class="form-container">
            <div class="form-section">
                <h3 class="form-title">Library Settings</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Default Borrow Duration (days)</label>
                        <input type="number" class="form-input" id="borrowDuration" value="14" min="1" max="90">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Daily Fine Amount (KSh)</label>
                        <input type="number" class="form-input" id="dailyFine" value="50" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Renewals Allowed</label>
                        <input type="number" class="form-input" id="maxRenewals" value="2" min="0" max="10">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Books Per User</label>
                        <input type="number" class="form-input" id="maxBooksPerUser" value="5" min="1" max="20">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3 class="form-title">Email Notifications</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="dueDateReminders" checked>
                            Send due date reminders
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="overdueNotifications" checked>
                            Send overdue notifications
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="reservationNotifications" checked>
                            Send reservation notifications
                        </label>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3 class="form-title">Library Information</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Library Name</label>
                        <input type="text" class="form-input" id="libraryName" value="THE SONGA Library">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Library Email</label>
                        <input type="email" class="form-input" id="libraryEmail" value="library@thesongawelfare.com">
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Library Address</label>
                        <input type="text" class="form-input" id="libraryAddress" value="Nairobi, Kenya">
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button class="btn btn-secondary" onclick="resetSettings()">Reset</button>
                <button class="btn btn-primary" onclick="saveLibrarySettings()">Save Settings</button>
            </div>
        </div>
    </template>

    <!-- Modal Templates -->
    <template id="addBookModalTemplate">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 class="modal-title">Add New Book</h3>
                <button class="modal-close" onclick="closeModal()">
                    <span class="material-icons-sharp">close</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addBookForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Title *</label>
                            <input type="text" class="form-input" id="bookTitle" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Author *</label>
                            <input type="text" class="form-input" id="bookAuthor" required>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">ISBN</label>
                            <input type="text" class="form-input" id="bookISBN">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Category *</label>
                            <select class="form-select" id="bookCategory" required>
                                <option value="">Select Category</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Published Year</label>
                            <input type="number" class="form-input" id="bookYear" min="1800" max="2024">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Publisher</label>
                            <input type="text" class="form-input" id="bookPublisher">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Total Copies *</label>
                            <input type="number" class="form-input" id="bookCopies" value="1" min="1" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Available Copies *</label>
                            <input type="number" class="form-input" id="bookAvailableCopies" value="1" min="0" required>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" id="bookDescription" rows="3" placeholder="Enter book description..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cover Image URL</label>
                        <input type="url" class="form-input" id="bookCoverImage" placeholder="https://example.com/cover.jpg">
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="bookFeatured">
                            Featured Book
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="addBook()">Add Book</button>
            </div>
        </div>
    </template>

    <template id="editBookModalTemplate">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 class="modal-title">Edit Book</h3>
                <button class="modal-close" onclick="closeModal()">
                    <span class="material-icons-sharp">close</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editBookForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Title *</label>
                            <input type="text" class="form-input" id="editBookTitle" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Author *</label>
                            <input type="text" class="form-input" id="editBookAuthor" required>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">ISBN</label>
                            <input type="text" class="form-input" id="editBookISBN">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Category *</label>
                            <select class="form-select" id="editBookCategory" required>
                                <option value="">Select Category</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Published Year</label>
                            <input type="number" class="form-input" id="editBookYear" min="1800" max="2024">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Publisher</label>
                            <input type="text" class="form-input" id="editBookPublisher">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Total Copies *</label>
                            <input type="number" class="form-input" id="editBookCopies" min="1" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Available Copies *</label>
                            <input type="number" class="form-input" id="editBookAvailableCopies" min="0" required>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" id="editBookDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cover Image URL</label>
                        <input type="url" class="form-input" id="editBookCoverImage">
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="editBookFeatured">
                            Featured Book
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="confirmDeleteBook()">Delete Book</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="updateBook()">Save Changes</button>
            </div>
        </div>
    </template>

    <template id="viewBookModalTemplate">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 class="modal-title">Book Details</h3>
                <button class="modal-close" onclick="closeModal()">
                    <span class="material-icons-sharp">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; margin-bottom: 2rem;">
                    <div>
                        <div class="book-cover" style="height: 250px; font-size: 4rem;">
                            {coverImage ? '<img src="{coverImage}" alt="{title}">' : '<span class="material-icons-sharp">menu_book</span>'}
                        </div>
                    </div>
                    <div>
                        <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem;">{title}</h2>
                        <p style="font-size: 1.125rem; color: var(--text-secondary); margin-bottom: 1rem;">by {author}</p>
                        
                        <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                            <span class="category-badge">{category}</span>
                            <span class="status-badge status-{availability}">{availability}</span>
                            {featured ? '<span class="status-badge" style="background: var(--primary); color: white;">Featured</span>' : ''}
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                                <div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">ISBN</div>
                                    <div style="font-weight: 500;">{isbn || 'N/A'}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Published Year</div>
                                    <div style="font-weight: 500;">{publishedYear || 'N/A'}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Publisher</div>
                                    <div style="font-weight: 500;">{publisher || 'N/A'}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Copies</div>
                                    <div style="font-weight: 500;">{availableCopies}/{totalCopies} available</div>
                                </div>
                            </div>
                        </div>
                        
                        {description ? `
                        <div>
                            <h4 style="font-weight: 600; margin-bottom: 0.5rem;">Description</h4>
                            <p style="color: var(--text-secondary); line-height: 1.6;">{description}</p>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                <div style="border-top: 1px solid var(--border); padding-top: 1.5rem;">
                    <h4 style="font-weight: 600; margin-bottom: 1rem;">Borrowing History</h4>
                    <div id="bookBorrowingHistory">
                        <!-- Will be populated -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                <button class="btn btn-primary" onclick="editBook('{id}')">Edit Book</button>
            </div>
        </div>
    </template>

    <template id="borrowBookModalTemplate">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Borrow Book</h3>
                <button class="modal-close" onclick="closeModal()">
                    <span class="material-icons-sharp">close</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="borrowBookForm">
                    <div class="form-group">
                        <label class="form-label">Select Book *</label>
                        <select class="form-select" id="borrowBookSelect" required onchange="updateBookDetails()">
                            <option value="">Select a book</option>
                        </select>
                        <div id="bookDetails" style="margin-top: 0.5rem; display: none;">
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                <span id="selectedBookTitle"></span> by <span id="selectedBookAuthor"></span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Select User *</label>
                        <select class="form-select" id="borrowUserSelect" required onchange="updateUserDetails()">
                            <option value="">Select a user</option>
                        </select>
                        <div id="userDetails" style="margin-top: 0.5rem; display: none;">
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                <span id="selectedUserName"></span> (<span id="selectedUserEmail"></span>)
                            </div>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Borrow Date</label>
                            <input type="date" class="form-input" id="borrowDate" value="{today}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Due Date *</label>
                            <input type="date" class="form-input" id="dueDate" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="processBorrow()">Borrow Book</button>
            </div>
        </div>
    </template>

    <template id="returnBookModalTemplate">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Return Book</h3>
                <button class="modal-close" onclick="closeModal()">
                    <span class="material-icons-sharp">close</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="returnBookForm">
                    <div class="form-group">
                        <label class="form-label">Select Borrow Record *</label>
                        <select class="form-select" id="returnBorrowSelect" required onchange="updateReturnDetails()">
                            <option value="">Select a borrow record</option>
                        </select>
                        <div id="returnDetails" style="margin-top: 0.5rem; display: none;">
                            <div style="background: var(--bg-primary); padding: 1rem; border-radius: var(--radius);">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.875rem;">
                                    <div>
                                        <div style="color: var(--text-secondary);">Book:</div>
                                        <div style="font-weight: 500;" id="returnBookTitle"></div>
                                    </div>
                                    <div>
                                        <div style="color: var(--text-secondary);">Borrower:</div>
                                        <div style="font-weight: 500;" id="returnUserName"></div>
                                    </div>
                                    <div>
                                        <div style="color: var(--text-secondary);">Due Date:</div>
                                        <div style="font-weight: 500;" id="returnDueDate"></div>
                                    </div>
                                    <div>
                                        <div style="color: var(--text-secondary);">Days Overdue:</div>
                                        <div style="font-weight: 500; color: var(--danger);" id="returnDaysOverdue"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group" id="fineSection" style="display: none;">
                        <label class="form-label">Fine Amount</label>
                        <input type="number" class="form-input" id="fineAmount" min="0" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="markFinePaid">
                            Mark fine as paid
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="processReturn()">Return Book</button>
            </div>
        </div>
    </template>

    <template id="addCategoryModalTemplate">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add New Category</h3>
                <button class="modal-close" onclick="closeModal()">
                    <span class="material-icons-sharp">close</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addCategoryForm">
                    <div class="form-group">
                        <label class="form-label">Category Name *</label>
                        <input type="text" class="form-input" id="categoryName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" id="categoryDescription" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="addCategory()">Add Category</button>
            </div>
        </div>
    </template>

    <template id="confirmationModalTemplate">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title" id="confirmationTitle">Confirm Action</h3>
                <button class="modal-close" onclick="closeModal()">
                    <span class="material-icons-sharp">close</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="confirmationMessage">Are you sure you want to perform this action?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-danger" id="confirmActionBtn">Confirm</button>
            </div>
        </div>
    </template>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBDZicoo7dFLtSmgRPvQE_gdm-tNOyCTXA",
            authDomain: "the-songa-77b1b.firebaseapp.com",
            databaseURL: "https://the-songa-77b1b-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "the-songa-77b1b",
            storageBucket: "the-songa-77b1b.firebasestorage.app",
            messagingSenderId: "123922889572",
            appId: "1:123922889572:web:482b2a624930baaf92d871"
        };

        // Initialize Firebase
        let database;
        let auth;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            auth = firebase.auth();
            console.log("Firebase initialized successfully for library admin");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            showAlert("Failed to connect to database. Please refresh the page.", "error");
        }

        // Global State
        let currentUser = null;
        let books = [];
        let categories = [];
        let borrowRecords = [];
        let users = [];
        let settings = {};
        let currentSection = 'overview';
        let currentModal = null;
        let currentEditBookId = null;
        let currentEditUserId = null;
        let charts = {};

        // DOM Elements
        const contentContainer = document.getElementById('contentContainer');
        const alertContainer = document.getElementById('alertContainer');
        const modalOverlay = document.getElementById('modalOverlay');

        // Initialize Library Admin
        async function initializeLibraryAdmin() {
            await checkAuth();
            loadSection('overview');
            setupEventListeners();
            startRealtimeUpdates();
        }

        // Check Authentication
        async function checkAuth() {
            // For demo, use localStorage
            const adminData = localStorage.getItem('the_songa_library_admin');
            
            if (!adminData) {
                showLoginModal();
                return;
            }
            
            try {
                const admin = JSON.parse(adminData);
                currentUser = admin;
                updateAdminUI();
            } catch (error) {
                showLoginModal();
            }
        }

        // Show Login Modal
        function showLoginModal() {
            const modalHTML = `
                <div class="modal" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Library Admin Login</h3>
                    </div>
                    <div class="modal-body">
                        <form id="loginForm">
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-input" id="loginEmail" value="admin@thesongawelfare.com" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-input" id="loginPassword" value="admin123" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" onclick="attemptLogin()">Login</button>
                    </div>
                </div>
            `;
            
            showModal(modalHTML);
        }

        // Attempt Login
        async function attemptLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            // Demo credentials
            if (email === 'admin@thesongawelfare.com' && password === 'admin123') {
                const adminData = {
                    uid: 'library_admin_001',
                    email: email,
                    firstName: 'Library',
                    lastName: 'Admin',
                    isAdmin: true
                };
                
                localStorage.setItem('the_songa_library_admin', JSON.stringify(adminData));
                currentUser = adminData;
                updateAdminUI();
                closeModal();
                showAlert('Login successful!', 'success');
                loadSection('overview');
            } else {
                showAlert('Invalid credentials', 'error');
            }
        }

        // Update Admin UI
        function updateAdminUI() {
            if (currentUser) {
                document.getElementById('adminName').textContent = 
                    `${currentUser.firstName} ${currentUser.lastName}`;
                document.getElementById('adminEmail').textContent = currentUser.email;
                document.getElementById('adminAvatar').textContent = 
                    currentUser.firstName.charAt(0) + currentUser.lastName.charAt(0);
            }
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = link.dataset.section;
                    loadSection(section);
                    
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                });
            });

            // Tabs
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('tab')) {
                    const tabId = e.target.dataset.tab;
                    
                    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tabId).classList.add('active');
                }
            });

            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', () => {
                loadSection(currentSection);
                showAlert('Data refreshed', 'success');
            });

            // Global search
            document.getElementById('globalSearch').addEventListener('input', debounce((e) => {
                const query = e.target.value.toLowerCase();
                searchData(query);
            }, 300));

            // Close modal on overlay click
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    closeModal();
                }
            });
        }

        // Load Section
        async function loadSection(section) {
            currentSection = section;
            
            // Update page title
            const pageTitle = document.getElementById('pageTitle');
            const titles = {
                overview: 'Library Overview',
                books: 'Book Management',
                borrow: 'Borrow Management',
                returns: 'Returns & Fines',
                users: 'Library Users',
                categories: 'Categories',
                reports: 'Reports & Analytics',
                settings: 'Library Settings'
            };
            pageTitle.textContent = titles[section] || 'Library Overview';
            
            // Show loading
            contentContainer.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            `;
            
            try {
                await fetchLibraryData();
                
                switch(section) {
                    case 'overview':
                        loadOverview();
                        break;
                    case 'books':
                        loadBooks();
                        break;
                    case 'borrow':
                        loadBorrow();
                        break;
                    case 'returns':
                        loadReturns();
                        break;
                    case 'users':
                        loadLibraryUsers();
                        break;
                    case 'categories':
                        loadCategories();
                        break;
                    case 'reports':
                        loadReports();
                        break;
                    case 'settings':
                        loadSettings();
                        break;
                    default:
                        loadOverview();
                }
            } catch (error) {
                console.error(`Error loading ${section}:`, error);
                showAlert(`Failed to load ${section} data`, 'error');
                contentContainer.innerHTML = `
                    <div class="empty-state">
                        <span class="material-icons-sharp">error</span>
                        <h3>Failed to load data</h3>
                        <p>Please try again or contact support if the problem persists.</p>
                        <button class="btn btn-secondary" onclick="loadSection('${section}')" style="margin-top: 1rem;">
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        // Fetch Library Data
        async function fetchLibraryData() {
            try {
                // Fetch books
                const booksSnapshot = await database.ref('libraryBooks').once('value');
                books = booksSnapshot.exists() ? Object.entries(booksSnapshot.val()).map(([id, data]) => ({ id, ...data })) : [];
                
                // Fetch categories from books
                categories = [...new Set(books.map(book => book.category).filter(Boolean))];
                
                // Fetch borrow records
                const borrowSnapshot = await database.ref('borrowRecords').once('value');
                borrowRecords = borrowSnapshot.exists() ? Object.values(borrowSnapshot.val()) : [];
                
                // Fetch users
                const usersSnapshot = await database.ref('users').once('value');
                users = usersSnapshot.exists() ? Object.values(usersSnapshot.val()) : [];
                
                // Fetch settings
                const settingsSnapshot = await database.ref('systemSettings').once('value');
                settings = settingsSnapshot.exists() ? settingsSnapshot.val() : {};
                
            } catch (error) {
                console.error('Error fetching library data:', error);
                throw error;
            }
        }

        // Load Overview
        function loadOverview() {
            const template = document.getElementById('overviewTemplate');
            contentContainer.innerHTML = template.innerHTML;
            
            updateOverviewStats();
            loadRecentBorrowings();
            loadRecentBooks();
            initOverviewCharts();
            
            // Setup chart period change
            document.getElementById('monthSelect').addEventListener('change', updateBorrowingChart);
        }

        // Update Overview Stats
        function updateOverviewStats() {
            const totalBooks = books.length;
            const availableBooks = books.filter(b => b.availability === 'available').length;
            const borrowedBooks = books.filter(b => b.availability === 'borrowed').length;
            const overdueRecords = borrowRecords.filter(r => {
                if (!r.returnDate) {
                    const dueDate = new Date(r.dueDate);
                    const today = new Date();
                    return dueDate < today;
                }
                return false;
            });
            
            document.getElementById('totalBooks').textContent = totalBooks;
            document.getElementById('availableBooks').textContent = availableBooks;
            document.getElementById('borrowedBooks').textContent = borrowedBooks;
            document.getElementById('overdueBooks').textContent = overdueRecords.length;
            
            // Update change indicators
            const availablePercentage = totalBooks > 0 ? Math.round((availableBooks / totalBooks) * 100) : 0;
            document.getElementById('availableChange').innerHTML = `
                <span class="material-icons-sharp">${availablePercentage > 50 ? 'trending_up' : 'trending_down'}</span>
                <span>${availablePercentage}% available</span>
            `;
            document.getElementById('availableChange').className = `stat-change ${availablePercentage > 50 ? 'positive' : 'negative'}`;
            
            document.getElementById('borrowedChange').innerHTML = `
                <span class="material-icons-sharp">trending_up</span>
                <span>${borrowedBooks} active borrows</span>
            `;
            
            document.getElementById('overdueChange').innerHTML = `
                <span class="material-icons-sharp">${overdueRecords.length > 0 ? 'warning' : 'check_circle'}</span>
                <span>${overdueRecords.length} need attention</span>
            `;
        }

        // Load Recent Borrowings
        function loadRecentBorrowings() {
            const tableBody = document.getElementById('recentBorrowingsBody');
            tableBody.innerHTML = '';
            
            const recentBorrows = borrowRecords
                .filter(r => !r.returnDate)
                .sort((a, b) => new Date(b.borrowDate) - new Date(a.borrowDate))
                .slice(0, 10);
            
            recentBorrows.forEach(record => {
                const book = books.find(b => b.id === record.bookId);
                const user = users.find(u => u.uid === record.userId);
                
                if (book && user) {
                    const dueDate = new Date(record.dueDate);
                    const today = new Date();
                    const daysLeft = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                    const status = daysLeft < 0 ? 'overdue' : daysLeft <= 3 ? 'pending' : 'active';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div style="font-weight: 600;">${book.title}</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">${book.author}</div>
                        </td>
                        <td>
                            <div style="font-weight: 500;">${user.firstName} ${user.lastName}</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">${user.email}</div>
                        </td>
                        <td>${formatDate(record.borrowDate)}</td>
                        <td>${formatDate(record.dueDate)}</td>
                        <td><span class="status-badge status-${status}">${status}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-icon" onclick="showReturnModal('${record.id}')" title="Return">
                                    <span class="material-icons-sharp">assignment_return</span>
                                </button>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                }
            });
        }

        // Load Recent Books
        function loadRecentBooks() {
            const grid = document.getElementById('recentBooksGrid');
            grid.innerHTML = '';
            
            const recentBooks = books
                .sort((a, b) => new Date(b.addedDate || 0) - new Date(a.addedDate || 0))
                .slice(0, 6);
            
            recentBooks.forEach(book => {
                const cardTemplate = document.getElementById('bookCardTemplate');
                const cardHTML = cardTemplate.innerHTML
                    .replace(/{id}/g, book.id)
                    .replace(/{title}/g, book.title || 'Untitled')
                    .replace(/{author}/g, book.author || 'Unknown')
                    .replace(/{coverImage}/g, book.coverImage || '')
                    .replace(/{rating}/g, book.rating || '0.0')
                    .replace(/{category}/g, book.category || 'Uncategorized')
                    .replace(/{availableCopies}/g, book.availableCopies || 0)
                    .replace(/{totalCopies}/g, book.totalCopies || 1)
                    .replace(/{availability}/g, book.availability || 'available')
                    .replace(/{featured}/g, book.featured || false);
                
                const cardDiv = document.createElement('div');
                cardDiv.innerHTML = cardHTML;
                grid.appendChild(cardDiv.firstElementChild);
            });
        }

        // Initialize Overview Charts
        function initOverviewCharts() {
            initBorrowingChart();
            initCategoriesChart();
        }

        // Initialize Borrowing Chart
        function initBorrowingChart() {
            const ctx = document.getElementById('borrowingChart').getContext('2d');
            
            if (charts.borrowingChart) {
                charts.borrowingChart.destroy();
            }
            
            // Last 30 days data
            const days = 30;
            const labels = [];
            const data = [];
            
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(formatDateShort(date));
                
                const borrows = borrowRecords.filter(r => {
                    const borrowDate = new Date(r.borrowDate);
                    return borrowDate.toDateString() === date.toDateString();
                }).length;
                
                data.push(borrows);
            }
            
            charts.borrowingChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Books Borrowed',
                        data: data,
                        borderColor: 'rgb(212, 175, 55)',
                        backgroundColor: 'rgba(212, 175, 55, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: 'rgb(212, 175, 55)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                drawBorder: false
                            },
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'nearest'
                    }
                }
            });
        }

        // Update Borrowing Chart
        function updateBorrowingChart() {
            const days = parseInt(document.getElementById('monthSelect').value);
            
            // Update chart with new data
            const labels = [];
            const data = [];
            
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(formatDateShort(date));
                
                const borrows = borrowRecords.filter(r => {
                    const borrowDate = new Date(r.borrowDate);
                    return borrowDate.toDateString() === date.toDateString();
                }).length;
                
                data.push(borrows);
            }
            
            charts.borrowingChart.data.labels = labels;
            charts.borrowingChart.data.datasets[0].data = data;
            charts.borrowingChart.update();
        }

        // Initialize Categories Chart
        function initCategoriesChart() {
            const ctx = document.getElementById('categoriesChart').getContext('2d');
            
            if (charts.categoriesChart) {
                charts.categoriesChart.destroy();
            }
            
            // Count books by category
            const categoryCounts = {};
            books.forEach(book => {
                if (book.category) {
                    categoryCounts[book.category] = (categoryCounts[book.category] || 0) + 1;
                }
            });
            
            const sortedCategories = Object.entries(categoryCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
            
            const labels = sortedCategories.map(([category]) => category);
            const data = sortedCategories.map(([, count]) => count);
            
            charts.categoriesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            'rgb(212, 175, 55)',
                            'rgb(59, 130, 246)',
                            'rgb(16, 185, 129)',
                            'rgb(245, 158, 11)',
                            'rgb(239, 68, 68)',
                            'rgb(139, 92, 246)',
                            'rgb(14, 165, 233)',
                            'rgb(34, 197, 94)'
                        ],
                        borderWidth: 1,
                        borderColor: 'var(--bg-secondary)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        }
                    },
                    cutout: '65%'
                }
            });
        }

        // Load Books Management
        function loadBooks() {
            const template = document.getElementById('booksTemplate');
            contentContainer.innerHTML = template.innerHTML;
            
            populateCategoryFilter();
            renderBooks();
            setupBookFilters();
            
            // Setup search
            document.getElementById('bookSearch').addEventListener('input', debounce(filterBooks, 300));
        }

        // Populate Category Filter
        function populateCategoryFilter() {
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = '<option value="all">All Categories</option>';
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });
        }

        // Render Books
        function renderBooks(filteredBooks = books) {
            // Grid View
            const grid = document.getElementById('booksGrid');
            grid.innerHTML = '';
            
            // Table View
            const tableBody = document.getElementById('booksTableBody');
            tableBody.innerHTML = '';
            
            filteredBooks.forEach(book => {
                // Grid View Card
                const cardTemplate = document.getElementById('bookCardTemplate');
                const cardHTML = cardTemplate.innerHTML
                    .replace(/{id}/g, book.id)
                    .replace(/{title}/g, book.title || 'Untitled')
                    .replace(/{author}/g, book.author || 'Unknown')
                    .replace(/{coverImage}/g, book.coverImage || '')
                    .replace(/{rating}/g, book.rating || '0.0')
                    .replace(/{category}/g, book.category || 'Uncategorized')
                    .replace(/{availableCopies}/g, book.availableCopies || 0)
                    .replace(/{totalCopies}/g, book.totalCopies || 1)
                    .replace(/{availability}/g, book.availability || 'available');
                
                const cardDiv = document.createElement('div');
                cardDiv.innerHTML = cardHTML;
                grid.appendChild(cardDiv.firstElementChild);
                
                // Table View Row
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div style="width: 40px; height: 60px; background: var(--primary-light); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; color: var(--primary);">
                                <span class="material-icons-sharp">menu_book</span>
                            </div>
                            <div>
                                <div style="font-weight: 600;">${book.title || 'Untitled'}</div>
                                <div style="font-size: 0.875rem; color: var(--text-secondary);">${book.author || 'Unknown'}</div>
                                <div style="font-size: 0.75rem; color: var(--text-light);">ISBN: ${book.isbn || 'N/A'}</div>
                            </div>
                        </div>
                    </td>
                    <td><span class="category-badge">${book.category || 'Uncategorized'}</span></td>
                    <td>${book.totalCopies || 1}</td>
                    <td>${book.availableCopies || 0}</td>
                    <td>${book.borrowCount || 0}</td>
                    <td><span class="status-badge status-${book.availability || 'available'}">${book.availability || 'available'}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon" onclick="viewBook('${book.id}')" title="View">
                                <span class="material-icons-sharp">visibility</span>
                            </button>
                            <button class="btn-icon edit" onclick="editBook('${book.id}')" title="Edit">
                                <span class="material-icons-sharp">edit</span>
                            </button>
                            <button class="btn-icon delete" onclick="deleteBook('${book.id}')" title="Delete">
                                <span class="material-icons-sharp">delete</span>
                            </button>
                            ${book.availableCopies > 0 ? `
                            <button class="btn-icon" onclick="showBorrowBookModal('${book.id}')" title="Borrow">
                                <span class="material-icons-sharp">bookmark</span>
                            </button>
                            ` : ''}
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Setup Book Filters
        function setupBookFilters() {
            document.getElementById('bookFilter').addEventListener('change', filterBooks);
            document.getElementById('categoryFilter').addEventListener('change', filterBooks);
            document.getElementById('sortFilter').addEventListener('change', filterBooks);
        }

        // Filter Books
        function filterBooks() {
            const statusFilter = document.getElementById('bookFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const sortFilter = document.getElementById('sortFilter').value;
            const searchQuery = document.getElementById('bookSearch').value.toLowerCase();
            
            let filteredBooks = [...books];
            
            // Apply search filter
            if (searchQuery) {
                filteredBooks = filteredBooks.filter(book => 
                    book.title?.toLowerCase().includes(searchQuery) ||
                    book.author?.toLowerCase().includes(searchQuery) ||
                    book.isbn?.toLowerCase().includes(searchQuery) ||
                    book.category?.toLowerCase().includes(searchQuery)
                );
            }
            
            // Apply status filter
            if (statusFilter !== 'all') {
                filteredBooks = filteredBooks.filter(book => book.availability === statusFilter);
            }
            
            // Apply category filter
            if (categoryFilter !== 'all') {
                filteredBooks = filteredBooks.filter(book => book.category === categoryFilter);
            }
            
            // Apply sorting
            filteredBooks.sort((a, b) => {
                switch(sortFilter) {
                    case 'newest':
                        return new Date(b.addedDate || 0) - new Date(a.addedDate || 0);
                    case 'oldest':
                        return new Date(a.addedDate || 0) - new Date(b.addedDate || 0);
                    case 'title':
                        return (a.title || '').localeCompare(b.title || '');
                    case 'author':
                        return (a.author || '').localeCompare(b.author || '');
                    case 'popular':
                        return (b.borrowCount || 0) - (a.borrowCount || 0);
                    default:
                        return 0;
                }
            });
            
            renderBooks(filteredBooks);
        }

        // Clear Filters
        function clearFilters() {
            document.getElementById('bookFilter').value = 'all';
            document.getElementById('categoryFilter').value = 'all';
            document.getElementById('sortFilter').value = 'newest';
            document.getElementById('bookSearch').value = '';
            filterBooks();
        }

        // Show Add Book Modal
        function showAddBookModal() {
            const template = document.getElementById('addBookModalTemplate');
            showModal(template.innerHTML);
            
            // Set today's date for borrow date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('borrowDate').value = today;
            
            // Set due date (default 14 days)
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 14);
            document.getElementById('dueDate').value = dueDate.toISOString().split('T')[0];
            
            // Populate categories
            setTimeout(() => {
                const categorySelect = document.getElementById('bookCategory');
                categorySelect.innerHTML = '<option value="">Select Category</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });
            }, 100);
        }

        // Add Book
        async function addBook() {
            const title = document.getElementById('bookTitle').value.trim();
            const author = document.getElementById('bookAuthor').value.trim();
            const isbn = document.getElementById('bookISBN').value.trim();
            const category = document.getElementById('bookCategory').value;
            const year = document.getElementById('bookYear').value;
            const publisher = document.getElementById('bookPublisher').value.trim();
            const totalCopies = parseInt(document.getElementById('bookCopies').value);
            const availableCopies = parseInt(document.getElementById('bookAvailableCopies').value);
            const description = document.getElementById('bookDescription').value.trim();
            const coverImage = document.getElementById('bookCoverImage').value.trim();
            const featured = document.getElementById('bookFeatured').checked;
            
            if (!title || !author || !category) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }
            
            if (availableCopies > totalCopies) {
                showAlert('Available copies cannot exceed total copies', 'error');
                return;
            }
            
            try {
                const bookId = `book_${Date.now()}`;
                const bookData = {
                    id: bookId,
                    title: title,
                    author: author,
                    isbn: isbn || null,
                    category: category,
                    publishedYear: year || null,
                    publisher: publisher || null,
                    description: description || null,
                    coverImage: coverImage || null,
                    totalCopies: totalCopies,
                    availableCopies: availableCopies,
                    borrowCount: 0,
                    rating: 0,
                    availability: availableCopies > 0 ? 'available' : 'unavailable',
                    featured: featured,
                    addedDate: new Date().toISOString(),
                    updatedDate: new Date().toISOString(),
                    location: `Shelf ${String.fromCharCode(65 + Math.floor(Math.random() * 5))}-${Math.floor(Math.random() * 20) + 1}`
                };
                
                await database.ref(`libraryBooks/${bookId}`).set(bookData);
                showAlert('Book added successfully', 'success');
                closeModal();
                loadSection('books');
            } catch (error) {
                console.error('Error adding book:', error);
                showAlert('Failed to add book', 'error');
            }
        }

        // View Book
        async function viewBook(bookId) {
            const book = books.find(b => b.id === bookId);
            if (!book) {
                showAlert('Book not found', 'error');
                return;
            }
            
            // Get book's borrowing history
            const bookBorrows = borrowRecords.filter(r => r.bookId === bookId);
            
            const template = document.getElementById('viewBookModalTemplate');
            let modalHTML = template.innerHTML
                .replace(/{id}/g, book.id)
                .replace(/{title}/g, book.title || 'Untitled')
                .replace(/{author}/g, book.author || 'Unknown')
                .replace(/{coverImage}/g, book.coverImage || '')
                .replace(/{category}/g, book.category || 'Uncategorized')
                .replace(/{availability}/g, book.availability || 'available')
                .replace(/{featured}/g, book.featured || false)
                .replace(/{isbn}/g, book.isbn || '')
                .replace(/{publishedYear}/g, book.publishedYear || '')
                .replace(/{publisher}/g, book.publisher || '')
                .replace(/{availableCopies}/g, book.availableCopies || 0)
                .replace(/{totalCopies}/g, book.totalCopies || 1)
                .replace(/{description}/g, book.description || '');
            
            showModal(modalHTML);
            
            // Populate borrowing history
            setTimeout(() => {
                const historyContainer = document.getElementById('bookBorrowingHistory');
                if (bookBorrows.length === 0) {
                    historyContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No borrowing history</p>';
                } else {
                    let historyHTML = '<div style="display: grid; gap: 0.5rem;">';
                    bookBorrows.slice(0, 5).forEach(record => {
                        const user = users.find(u => u.uid === record.userId);
                        const returnDate = record.returnDate ? formatDate(record.returnDate) : 'Not returned yet';
                        historyHTML += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: var(--bg-primary); border-radius: var(--radius);">
                                <div>
                                    <div style="font-weight: 500;">${user ? user.firstName + ' ' + user.lastName : 'Unknown User'}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                        Borrowed: ${formatDate(record.borrowDate)} | Returned: ${returnDate}
                                    </div>
                                </div>
                                <span class="status-badge ${record.returnDate ? 'status-returned' : 'status-borrowed'}">
                                    ${record.returnDate ? 'Returned' : 'Active'}
                                </span>
                            </div>
                        `;
                    });
                    historyHTML += '</div>';
                    historyContainer.innerHTML = historyHTML;
                }
            }, 100);
        }

        // Edit Book
        async function editBook(bookId) {
            const book = books.find(b => b.id === bookId);
            if (!book) {
                showAlert('Book not found', 'error');
                return;
            }
            
            currentEditBookId = bookId;
            
            const template = document.getElementById('editBookModalTemplate');
            showModal(template.innerHTML);
            
            // Populate form
            setTimeout(() => {
                document.getElementById('editBookTitle').value = book.title || '';
                document.getElementById('editBookAuthor').value = book.author || '';
                document.getElementById('editBookISBN').value = book.isbn || '';
                document.getElementById('editBookYear').value = book.publishedYear || '';
                document.getElementById('editBookPublisher').value = book.publisher || '';
                document.getElementById('editBookCopies').value = book.totalCopies || 1;
                document.getElementById('editBookAvailableCopies').value = book.availableCopies || 0;
                document.getElementById('editBookDescription').value = book.description || '';
                document.getElementById('editBookCoverImage').value = book.coverImage || '';
                document.getElementById('editBookFeatured').checked = book.featured || false;
                
                // Populate categories
                const categorySelect = document.getElementById('editBookCategory');
                categorySelect.innerHTML = '<option value="">Select Category</option>';
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    if (cat === book.category) option.selected = true;
                    categorySelect.appendChild(option);
                });
            }, 100);
        }

        // Update Book
        async function updateBook() {
            if (!currentEditBookId) return;
            
            const title = document.getElementById('editBookTitle').value.trim();
            const author = document.getElementById('editBookAuthor').value.trim();
            const isbn = document.getElementById('editBookISBN').value.trim();
            const category = document.getElementById('editBookCategory').value;
            const year = document.getElementById('editBookYear').value;
            const publisher = document.getElementById('editBookPublisher').value.trim();
            const totalCopies = parseInt(document.getElementById('editBookCopies').value);
            const availableCopies = parseInt(document.getElementById('editBookAvailableCopies').value);
            const description = document.getElementById('editBookDescription').value.trim();
            const coverImage = document.getElementById('editBookCoverImage').value.trim();
            const featured = document.getElementById('editBookFeatured').checked;
            
            if (!title || !author || !category) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }
            
            if (availableCopies > totalCopies) {
                showAlert('Available copies cannot exceed total copies', 'error');
                return;
            }
            
            try {
                const updates = {
                    title: title,
                    author: author,
                    isbn: isbn || null,
                    category: category,
                    publishedYear: year || null,
                    publisher: publisher || null,
                    description: description || null,
                    coverImage: coverImage || null,
                    totalCopies: totalCopies,
                    availableCopies: availableCopies,
                    featured: featured,
                    updatedDate: new Date().toISOString(),
                    availability: availableCopies > 0 ? 'available' : 'unavailable'
                };
                
                await database.ref(`libraryBooks/${currentEditBookId}`).update(updates);
                showAlert('Book updated successfully', 'success');
                closeModal();
                loadSection('books');
            } catch (error) {
                console.error('Error updating book:', error);
                showAlert('Failed to update book', 'error');
            }
        }

        // Delete Book
        async function deleteBook(bookId) {
            if (!bookId) bookId = currentEditBookId;
            if (!bookId) return;
            
            showConfirmation(
                'Delete Book',
                'Are you sure you want to delete this book? This action cannot be undone.',
                async () => {
                    try {
                        await database.ref(`libraryBooks/${bookId}`).remove();
                        
                        // Also remove related borrow records
                        const bookBorrows = borrowRecords.filter(r => r.bookId === bookId);
                        for (const record of bookBorrows) {
                            await database.ref(`borrowRecords/${record.id}`).remove();
                        }
                        
                        showAlert('Book deleted successfully', 'success');
                        closeModal();
                        loadSection('books');
                    } catch (error) {
                        console.error('Error deleting book:', error);
                        showAlert('Failed to delete book', 'error');
                    }
                }
            );
        }

        // Confirm Delete Book
        function confirmDeleteBook() {
            deleteBook(currentEditBookId);
        }

        // Load Borrow Management
        function loadBorrow() {
            const template = document.getElementById('borrowTemplate');
            contentContainer.innerHTML = template.innerHTML;
            
            loadActiveBorrows();
            loadOverdueBorrows();
            loadBorrowHistory();
        }

        // Load Active Borrows
        function loadActiveBorrows() {
            const tableBody = document.getElementById('activeBorrowsBody');
            tableBody.innerHTML = '';
            
            const activeBorrows = borrowRecords.filter(r => !r.returnDate);
            
            activeBorrows.forEach(record => {
                const book = books.find(b => b.id === record.bookId);
                const user = users.find(u => u.uid === record.userId);
                
                if (book && user) {
                    const dueDate = new Date(record.dueDate);
                    const today = new Date();
                    const daysLeft = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div style="font-weight: 600;">${book.title}</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">${book.author}</div>
                        </td>
                        <td>
                            <div style="font-weight: 500;">${user.firstName} ${user.lastName}</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">${user.email}</div>
                        </td>
                        <td>${formatDate(record.borrowDate)}</td>
                        <td>${formatDate(record.dueDate)}</td>
                        <td>
                            <span style="color: ${daysLeft < 0 ? 'var(--danger)' : daysLeft <= 3 ? 'var(--warning)' : 'var(--success)'}; font-weight: 600;">
                                ${daysLeft < 0 ? `${Math.abs(daysLeft)} days overdue` : `${daysLeft} days left`}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-icon" onclick="showReturnModal('${record.id}')" title="Return">
                                    <span class="material-icons-sharp">assignment_return</span>
                                </button>
                                ${daysLeft > 0 ? `
                                <button class="btn-icon" onclick="renewBorrow('${record.id}')" title="Renew">
                                    <span class="material-icons-sharp">autorenew</span>
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                }
            });
        }

        // Load Overdue Borrows
        function loadOverdueBorrows() {
            const tableBody = document.getElementById('overdueBorrowsBody');
            tableBody.innerHTML = '';
            
            const today = new Date();
            const overdueBorrows = borrowRecords.filter(r => {
                if (!r.returnDate) {
                    const dueDate = new Date(r.dueDate);
                    return dueDate < today;
                }
                return false;
            });
            
            overdueBorrows.forEach(record => {
                const book = books.find(b => b.id === record.bookId);
                const user = users.find(u => u.uid === record.userId);
                
                if (book && user) {
                    const dueDate = new Date(record.dueDate);
                    const daysOverdue = Math.ceil((today - dueDate) / (1000 * 60 * 60 * 24));
                    const fineAmount = daysOverdue * (settings.dailyFine || 50);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div style="font-weight: 600;">${book.title}</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">${book.author}</div>
                        </td>
                        <td>
                            <div style="font-weight: 500;">${user.firstName} ${user.lastName}</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">${user.email}</div>
                        </td>
                        <td>${formatDate(record.dueDate)}</td>
                        <td>
                            <span style="color: var(--danger); font-weight: 600;">
                                ${daysOverdue} days
                            </span>
                        </td>
                        <td>
                            <span style="font-weight: 600; color: var(--danger);">
                                KSh ${fineAmount}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="contactUser('${user.uid}')">
                                Contact
                            </button>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-icon" onclick="showReturnModal('${record.id}')" title="Return">
                                    <span class="material-icons-sharp">assignment_return</span>
                                </button>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                }
            });
        }

        // Load Borrow History
        function loadBorrowHistory() {
            const tableBody = document.getElementById('borrowHistoryBody');
            tableBody.innerHTML = '';
            
            const returnedBorrows = borrowRecords.filter(r => r.returnDate)
                .sort((a, b) => new Date(b.returnDate) - new Date(a.returnDate))
                .slice(0, 50);
            
            returnedBorrows.forEach(record => {
                const book = books.find(b => b.id === record.bookId);
                const user = users.find(u => u.uid === record.userId);
                
                if (book && user) {
                    const borrowDate = new Date(record.borrowDate);
                    const returnDate = new Date(record.returnDate);
                    const duration = Math.ceil((returnDate - borrowDate) / (1000 * 60 * 60 * 24));
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div style="font-weight: 600;">${book.title}</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">${book.author}</div>
                        </td>
                        <td>
                            <div style="font-weight: 500;">${user.firstName} ${user.lastName}</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">${user.email}</div>
                        </td>
                        <td>${formatDate(record.borrowDate)}</td>
                        <td>${formatDate(record.returnDate)}</td>
                        <td>${duration} days</td>
                        <td>
                            <span class="status-badge status-returned">Returned</span>
                        </td>
                    `;
                    tableBody.appendChild(row);
                }
            });
        }

        // Show Borrow Book Modal
        function showBorrowBookModal(preSelectedBookId = null) {
            const template = document.getElementById('borrowBookModalTemplate');
            const today = new Date().toISOString().split('T')[0];
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + (settings.borrowDuration || 14));
            const dueDateStr = dueDate.toISOString().split('T')[0];
            
            let modalHTML = template.innerHTML.replace(/{today}/g, today);
            showModal(modalHTML);
            
            // Set due date
            setTimeout(() => {
                document.getElementById('dueDate').value = dueDateStr;
                
                // Populate books dropdown
                const bookSelect = document.getElementById('borrowBookSelect');
                bookSelect.innerHTML = '<option value="">Select a book</option>';
                books
                    .filter(book => book.availableCopies > 0)
                    .forEach(book => {
                        const option = document.createElement('option');
                        option.value = book.id;
                        option.textContent = `${book.title} by ${book.author} (${book.availableCopies} available)`;
                        if (book.id === preSelectedBookId) option.selected = true;
                        bookSelect.appendChild(option);
                    });
                
                // Populate users dropdown
                const userSelect = document.getElementById('borrowUserSelect');
                userSelect.innerHTML = '<option value="">Select a user</option>';
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.uid;
                    option.textContent = `${user.firstName} ${user.lastName} (${user.email})`;
                    userSelect.appendChild(option);
                });
                
                // Update details if book is pre-selected
                if (preSelectedBookId) {
                    updateBookDetails();
                }
            }, 100);
        }

        // Update Book Details in Borrow Modal
        function updateBookDetails() {
            const bookId = document.getElementById('borrowBookSelect').value;
            const book = books.find(b => b.id === bookId);
            
            const detailsDiv = document.getElementById('bookDetails');
            const titleSpan = document.getElementById('selectedBookTitle');
            const authorSpan = document.getElementById('selectedBookAuthor');
            
            if (book) {
                titleSpan.textContent = book.title;
                authorSpan.textContent = book.author;
                detailsDiv.style.display = 'block';
            } else {
                detailsDiv.style.display = 'none';
            }
        }

        // Update User Details in Borrow Modal
        function updateUserDetails() {
            const userId = document.getElementById('borrowUserSelect').value;
            const user = users.find(u => u.uid === userId);
            
            const detailsDiv = document.getElementById('userDetails');
            const nameSpan = document.getElementById('selectedUserName');
            const emailSpan = document.getElementById('selectedUserEmail');
            
            if (user) {
                nameSpan.textContent = `${user.firstName} ${user.lastName}`;
                emailSpan.textContent = user.email;
                detailsDiv.style.display = 'block';
            } else {
                detailsDiv.style.display = 'none';
            }
        }

        // Process Borrow
        async function processBorrow() {
            const bookId = document.getElementById('borrowBookSelect').value;
            const userId = document.getElementById('borrowUserSelect').value;
            const borrowDate = document.getElementById('borrowDate').value;
            const dueDate = document.getElementById('dueDate').value;
            
            if (!bookId || !userId || !dueDate) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }
            
            const book = books.find(b => b.id === bookId);
            const user = users.find(u => u.uid === userId);
            
            if (!book || !user) {
                showAlert('Invalid book or user selected', 'error');
                return;
            }
            
            if (book.availableCopies < 1) {
                showAlert('This book is not available for borrowing', 'error');
                return;
            }
            
            try {
                const borrowId = `borrow_${Date.now()}`;
                const borrowDateStr = borrowDate || new Date().toISOString();
                
                // Create borrow record
                const borrowData = {
                    id: borrowId,
                    bookId: bookId,
                    userId: userId,
                    bookTitle: book.title,
                    userName: `${user.firstName} ${user.lastName}`,
                    userEmail: user.email,
                    borrowDate: borrowDateStr,
                    dueDate: dueDate,
                    returnDate: null,
                    status: 'borrowed',
                    renewals: 0,
                    fineAmount: 0,
                    paid: false,
                    createdAt: new Date().toISOString()
                };
                
                // Update book availability
                const bookUpdates = {
                    availableCopies: book.availableCopies - 1,
                    borrowCount: (book.borrowCount || 0) + 1,
                    availability: (book.availableCopies - 1) > 0 ? 'available' : 'borrowed'
                };
                
                // Update user's borrowed books
                const userBorrowedBooks = user.borrowedBooks || [];
                if (!userBorrowedBooks.includes(bookId)) {
                    userBorrowedBooks.push(bookId);
                }
                
                await database.ref(`borrowRecords/${borrowId}`).set(borrowData);
                await database.ref(`libraryBooks/${bookId}`).update(bookUpdates);
                await database.ref(`users/${userId}/borrowedBooks`).set(userBorrowedBooks);
                
                showAlert('Book borrowed successfully', 'success');
                closeModal();
                loadSection('borrow');
            } catch (error) {
                console.error('Error processing borrow:', error);
                showAlert('Failed to process borrow', 'error');
            }
        }

        // Show Return Modal
        function showReturnModal(borrowId = null) {
            const template = document.getElementById('returnBookModalTemplate');
            showModal(template.innerHTML);
            
            setTimeout(() => {
                const borrowSelect = document.getElementById('returnBorrowSelect');
                borrowSelect.innerHTML = '<option value="">Select a borrow record</option>';
                
                const activeBorrows = borrowRecords.filter(r => !r.returnDate);
                activeBorrows.forEach(record => {
                    const book = books.find(b => b.id === record.bookId);
                    const user = users.find(u => u.uid === record.userId);
                    
                    if (book && user) {
                        const option = document.createElement('option');
                        option.value = record.id;
                        option.textContent = `${book.title} - ${user.firstName} ${user.lastName} (Due: ${formatDate(record.dueDate)})`;
                        if (record.id === borrowId) option.selected = true;
                        borrowSelect.appendChild(option);
                    }
                });
                
                // Update details if borrow is pre-selected
                if (borrowId) {
                    updateReturnDetails();
                }
            }, 100);
        }

        // Update Return Details
        function updateReturnDetails() {
            const borrowId = document.getElementById('returnBorrowSelect').value;
            const record = borrowRecords.find(r => r.id === borrowId);
            
            const detailsDiv = document.getElementById('returnDetails');
            const bookTitle = document.getElementById('returnBookTitle');
            const userName = document.getElementById('returnUserName');
            const dueDate = document.getElementById('returnDueDate');
            const daysOverdue = document.getElementById('returnDaysOverdue');
            const fineAmount = document.getElementById('fineAmount');
            const fineSection = document.getElementById('fineSection');
            
            if (record) {
                const book = books.find(b => b.id === record.bookId);
                const user = users.find(u => u.uid === record.userId);
                const today = new Date();
                const due = new Date(record.dueDate);
                const overdueDays = Math.max(0, Math.ceil((today - due) / (1000 * 60 * 60 * 24)));
                const fine = overdueDays * (settings.dailyFine || 50);
                
                if (book && user) {
                    bookTitle.textContent = book.title;
                    userName.textContent = `${user.firstName} ${user.lastName}`;
                    dueDate.textContent = formatDate(record.dueDate);
                    daysOverdue.textContent = `${overdueDays} days`;
                    fineAmount.value = fine;
                    
                    detailsDiv.style.display = 'block';
                    fineSection.style.display = overdueDays > 0 ? 'block' : 'none';
                }
            } else {
                detailsDiv.style.display = 'none';
                fineSection.style.display = 'none';
            }
        }

        // Process Return
        async function processReturn() {
            const borrowId = document.getElementById('returnBorrowSelect').value;
            const markFinePaid = document.getElementById('markFinePaid').checked;
            
            if (!borrowId) {
                showAlert('Please select a borrow record', 'error');
                return;
            }
            
            const record = borrowRecords.find(r => r.id === borrowId);
            if (!record) {
                showAlert('Borrow record not found', 'error');
                return;
            }
            
            const book = books.find(b => b.id === record.bookId);
            const user = users.find(u => u.uid === record.userId);
            
            if (!book || !user) {
                showAlert('Invalid borrow record', 'error');
                return;
            }
            
            try {
                const today = new Date();
                const due = new Date(record.dueDate);
                const overdueDays = Math.max(0, Math.ceil((today - due) / (1000 * 60 * 60 * 24)));
                const fine = overdueDays * (settings.dailyFine || 50);
                
                // Update borrow record
                const updates = {
                    returnDate: today.toISOString(),
                    fineAmount: fine,
                    paid: markFinePaid || fine === 0,
                    status: 'returned'
                };
                
                // Update book availability
                const bookUpdates = {
                    availableCopies: book.availableCopies + 1,
                    availability: (book.availableCopies + 1) > 0 ? 'available' : 'unavailable'
                };
                
                // Update user's borrowed books
                const userBorrowedBooks = user.borrowedBooks || [];
                const updatedBorrowedBooks = userBorrowedBooks.filter(id => id !== record.bookId);
                
                await database.ref(`borrowRecords/${borrowId}`).update(updates);
                await database.ref(`libraryBooks/${record.bookId}`).update(bookUpdates);
                await database.ref(`users/${record.userId}/borrowedBooks`).set(updatedBorrowedBooks);
                
                showAlert('Book returned successfully', 'success');
                closeModal();
                loadSection('borrow');
            } catch (error) {
                console.error('Error processing return:', error);
                showAlert('Failed to process return', 'error');
            }
        }

        // Renew Borrow
        async function renewBorrow(borrowId) {
            const record = borrowRecords.find(r => r.id === borrowId);
            if (!record) {
                showAlert('Borrow record not found', 'error');
                return;
            }
            
            if (record.renewals >= (settings.maxRenewals || 2)) {
                showAlert('Maximum renewals reached for this book', 'error');
                return;
            }
            
            // Extend due date by borrow duration
            const newDueDate = new Date(record.dueDate);
            newDueDate.setDate(newDueDate.getDate() + (settings.borrowDuration || 14));
            
            try {
                await database.ref(`borrowRecords/${borrowId}`).update({
                    dueDate: newDueDate.toISOString(),
                    renewals: (record.renewals || 0) + 1
                });
                
                showAlert('Book renewed successfully', 'success');
                loadSection('borrow');
            } catch (error) {
                console.error('Error renewing borrow:', error);
                showAlert('Failed to renew book', 'error');
            }
        }

        // Load Returns & Fines
        function loadReturns() {
            const template = document.getElementById('returnsTemplate');
            contentContainer.innerHTML = template.innerHTML;
            
            updateReturnsStats();
            loadReturnsList();
            loadFinesList();
        }

        // Update Returns Stats
        function updateReturnsStats() {
            const pendingReturns = borrowRecords.filter(r => !r.returnDate).length;
            const allReturns = borrowRecords.filter(r => r.returnDate);
            const totalFines = allReturns.reduce((sum, r) => sum + (r.fineAmount || 0), 0);
            const paidFines = allReturns.reduce((sum, r) => sum + (r.paid ? (r.fineAmount || 0) : 0), 0);
            
            document.getElementById('pendingReturns').textContent = pendingReturns;
            document.getElementById('totalFines').textContent = `KSh ${totalFines}`;
            document.getElementById('paidFines').textContent = `KSh ${paidFines}`;
        }

        // Load Returns List
        function loadReturnsList() {
            const tableBody = document.getElementById('returnsTableBody');
            tableBody.innerHTML = '';
            
            const returnedBorrows = borrowRecords.filter(r => r.returnDate)
                .sort((a, b) => new Date(b.returnDate) - new Date(a.returnDate));
            
            returnedBorrows.forEach(record => {
                const book = books.find(b => b.id === record.bookId);
                const user = users.find(u => u.uid === record.userId);
                
                if (book && user) {
                    const due = new Date(record.dueDate);
                    const returnDate = new Date(record.returnDate);
                    const overdueDays = Math.max(0, Math.ceil((returnDate - due) / (1000 * 60 * 60 * 24)));
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div style="font-weight: 600;">${book.title}</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">${book.author}</div>
                        </td>
                        <td>
                            <div style="font-weight: 500;">${user.firstName} ${user.lastName}</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">${user.email}</div>
                        </td>
                        <td>${formatDate(record.returnDate)}</td>
                        <td>${overdueDays > 0 ? `${overdueDays} days` : 'On time'}</td>
                        <td>KSh ${record.fineAmount || 0}</td>
                        <td>
                            <span class="status-badge ${record.paid ? 'status-returned' : 'status-overdue'}">
                                ${record.paid ? 'Paid' : 'Unpaid'}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                ${!record.paid && record.fineAmount > 0 ? `
                                <button class="btn-icon" onclick="markFineAsPaid('${record.id}')" title="Mark as Paid">
                                    <span class="material-icons-sharp">check_circle</span>
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                }
            });
        }

        // Load Fines List
        function loadFinesList() {
            const tableBody = document.getElementById('finesTableBody');
            tableBody.innerHTML = '';
            
            const fines = borrowRecords.filter(r => r.fineAmount > 0)
                .sort((a, b) => (b.fineAmount || 0) - (a.fineAmount || 0));
            
            fines.forEach(record => {
                const book = books.find(b => b.id === record.bookId);
                const user = users.find(u => u.uid === record.userId);
                
                if (book && user) {
                    const due = new Date(record.dueDate);
                    const returnDate = record.returnDate ? new Date(record.returnDate) : new Date();
                    const overdueDays = Math.max(0, Math.ceil((returnDate - due) / (1000 * 60 * 60 * 24)));
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div style="font-weight: 500;">${user.firstName} ${user.lastName}</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">${user.email}</div>
                        </td>
                        <td>
                            <div style="font-weight: 600;">${book.title}</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">${book.author}</div>
                        </td>
                        <td>${formatDate(record.dueDate)}</td>
                        <td>${overdueDays} days</td>
                        <td>
                            <span style="font-weight: 600; color: var(--danger);">
                                KSh ${record.fineAmount || 0}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge ${record.paid ? 'status-returned' : 'status-overdue'}">
                                ${record.paid ? 'Paid' : 'Unpaid'}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                ${!record.paid ? `
                                <button class="btn-icon" onclick="markFineAsPaid('${record.id}')" title="Mark as Paid">
                                    <span class="material-icons-sharp">check_circle</span>
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                }
            });
        }

        // Mark Fine as Paid
        async function markFineAsPaid(borrowId) {
            try {
                await database.ref(`borrowRecords/${borrowId}`).update({
                    paid: true
                });
                
                showAlert('Fine marked as paid', 'success');
                loadSection('returns');
            } catch (error) {
                console.error('Error updating fine:', error);
                showAlert('Failed to update fine', 'error');
            }
        }

        // Load Library Users
        function loadLibraryUsers() {
            const template = document.getElementById('usersTemplate');
            contentContainer.innerHTML = template.innerHTML;
            
            renderLibraryUsers();
            
            // Setup search and filters
            document.getElementById('userSearch').addEventListener('input', debounce(filterUsers, 300));
            document.getElementById('userFilter').addEventListener('change', filterUsers);
            document.getElementById('userTierFilter').addEventListener('change', filterUsers);
        }

        // Render Library Users
        function renderLibraryUsers(filteredUsers = users) {
            const tableBody = document.getElementById('libraryUsersBody');
            tableBody.innerHTML = '';
            
            filteredUsers.forEach(user => {
                // Get user's borrowing stats
                const userBorrows = borrowRecords.filter(r => r.userId === user.uid);
                const activeBorrows = userBorrows.filter(r => !r.returnDate);
                const overdueBorrows = activeBorrows.filter(r => {
                    const due = new Date(r.dueDate);
                    const today = new Date();
                    return due < today;
                });
                const totalFines = userBorrows.reduce((sum, r) => sum + (r.fineAmount || 0), 0);
                const unpaidFines = userBorrows.reduce((sum, r) => sum + (!r.paid ? (r.fineAmount || 0) : 0), 0);
                
                const row = document.createElement('tr');
                const tierClass = `tier-${user.membershipTier || 'explorer'}`;
                const statusClass = user.membershipStatus === 'suspended' ? 'status-suspended' : 'status-active';
                
                row.innerHTML = `
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 600; color: var(--secondary);">
                                ${(user.firstName?.charAt(0) || '') + (user.lastName?.charAt(0) || '')}
                            </div>
                            <div>
                                <div style="font-weight: 600;">${user.firstName || ''} ${user.lastName || ''}</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">${user.email || 'N/A'}</div>
                            </div>
                        </div>
                    </td>
                    <td><span class="tier-badge ${tierClass}">${user.membershipTier || 'explorer'}</span></td>
                    <td>${activeBorrows.length}</td>
                    <td>
                        <span style="color: ${overdueBorrows.length > 0 ? 'var(--danger)' : 'var(--text-secondary)'}; font-weight: 600;">
                            ${overdueBorrows.length}
                        </span>
                    </td>
                    <td>
                        <span style="color: ${unpaidFines > 0 ? 'var(--danger)' : 'var(--text-secondary)'}; font-weight: 600;">
                            KSh ${unpaidFines}
                        </span>
                    </td>
                    <td><span class="status-badge ${statusClass}">${user.membershipStatus || 'active'}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon" onclick="viewUserBorrowings('${user.uid}')" title="View Borrowings">
                                <span class="material-icons-sharp">visibility</span>
                            </button>
                            <button class="btn-icon" onclick="contactUser('${user.uid}')" title="Contact">
                                <span class="material-icons-sharp">email</span>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Filter Users
        function filterUsers() {
            const searchQuery = document.getElementById('userSearch').value.toLowerCase();
            const statusFilter = document.getElementById('userFilter').value;
            const tierFilter = document.getElementById('userTierFilter').value;
            
            let filteredUsers = [...users];
            
            // Apply search filter
            if (searchQuery) {
                filteredUsers = filteredUsers.filter(user => 
                    user.firstName?.toLowerCase().includes(searchQuery) ||
                    user.lastName?.toLowerCase().includes(searchQuery) ||
                    user.email?.toLowerCase().includes(searchQuery)
                );
            }
            
            // Apply tier filter
            if (tierFilter !== 'all') {
                filteredUsers = filteredUsers.filter(user => user.membershipTier === tierFilter);
            }
            
            // Apply status filter
            if (statusFilter !== 'all') {
                filteredUsers = filteredUsers.filter(user => {
                    const userBorrows = borrowRecords.filter(r => r.userId === user.uid);
                    
                    switch(statusFilter) {
                        case 'active':
                            return user.membershipStatus === 'active';
                        case 'overdue':
                            const activeBorrows = userBorrows.filter(r => !r.returnDate);
                            return activeBorrows.some(r => {
                                const due = new Date(r.dueDate);
                                const today = new Date();
                                return due < today;
                            });
                        case 'fines':
                            return userBorrows.some(r => (r.fineAmount || 0) > 0 && !r.paid);
                        default:
                            return true;
                    }
                });
            }
            
            renderLibraryUsers(filteredUsers);
        }

        // View User Borrowings
        function viewUserBorrowings(userId) {
            const user = users.find(u => u.uid === userId);
            if (!user) {
                showAlert('User not found', 'error');
                return;
            }
            
            const userBorrows = borrowRecords.filter(r => r.userId === userId);
            
            let modalHTML = `
                <div class="modal modal-lg">
                    <div class="modal-header">
                        <h3 class="modal-title">${user.firstName} ${user.lastName}'s Borrowings</h3>
                        <button class="modal-close" onclick="closeModal()">
                            <span class="material-icons-sharp">close</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 1.5rem;">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="width: 60px; height: 60px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 600; color: var(--secondary); font-size: 1.5rem;">
                                    ${(user.firstName?.charAt(0) || '') + (user.lastName?.charAt(0) || '')}
                                </div>
                                <div>
                                    <h4 style="font-size: 1.25rem; font-weight: 600;">${user.firstName} ${user.lastName}</h4>
                                    <p style="color: var(--text-secondary);">${user.email}</p>
                                    <p style="color: var(--text-secondary); font-size: 0.875rem;">
                                        <span class="tier-badge tier-${user.membershipTier || 'explorer'}">${user.membershipTier || 'explorer'}</span>
                                        <span class="status-badge status-${user.membershipStatus || 'active'}" style="margin-left: 0.5rem;">${user.membershipStatus || 'active'}</span>
                                    </p>
                                </div>
                            </div>
                        </div>
            `;
            
            if (userBorrows.length === 0) {
                modalHTML += `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <span class="material-icons-sharp" style="font-size: 3rem; margin-bottom: 1rem;">menu_book</span>
                        <p>No borrowing history</p>
                    </div>
                `;
            } else {
                modalHTML += `
                    <div class="data-table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Book</th>
                                    <th>Borrow Date</th>
                                    <th>Due Date</th>
                                    <th>Return Date</th>
                                    <th>Fine</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                userBorrows.forEach(record => {
                    const book = books.find(b => b.id === record.bookId);
                    const due = new Date(record.dueDate);
                    const today = new Date();
                    const isOverdue = !record.returnDate && due < today;
                    
                    modalHTML += `
                        <tr>
                            <td>
                                <div style="font-weight: 600;">${book?.title || 'Unknown Book'}</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">${book?.author || 'Unknown Author'}</div>
                            </td>
                            <td>${formatDate(record.borrowDate)}</td>
                            <td>${formatDate(record.dueDate)}</td>
                            <td>${record.returnDate ? formatDate(record.returnDate) : 'Not returned'}</td>
                            <td>KSh ${record.fineAmount || 0}</td>
                            <td>
                                <span class="status-badge ${record.returnDate ? 'status-returned' : isOverdue ? 'status-overdue' : 'status-borrowed'}">
                                    ${record.returnDate ? 'Returned' : isOverdue ? 'Overdue' : 'Active'}
                                </span>
                            </td>
                        </tr>
                    `;
                });
                
                modalHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            modalHTML += `
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                    </div>
                </div>
            `;
            
            showModal(modalHTML);
        }

        // Contact User
        function contactUser(userId) {
            const user = users.find(u => u.uid === userId);
            if (!user) {
                showAlert('User not found', 'error');
                return;
            }
            
            // For demo, show contact info
            showAlert(`Contact ${user.firstName} ${user.lastName} at ${user.email}${user.phone ? ` or ${user.phone}` : ''}`, 'info');
        }

        // Load Categories
        function loadCategories() {
            const template = document.getElementById('categoriesTemplate');
            contentContainer.innerHTML = template.innerHTML;
            
            renderCategories();
        }

        // Render Categories
        function renderCategories() {
            const grid = document.getElementById('categoriesGrid');
            grid.innerHTML = '';
            
            // Count books per category
            const categoryStats = {};
            books.forEach(book => {
                if (book.category) {
                    if (!categoryStats[book.category]) {
                        categoryStats[book.category] = {
                            total: 0,
                            available: 0,
                            borrowed: 0
                        };
                    }
                    categoryStats[book.category].total++;
                    categoryStats[book.category].available += book.availableCopies || 0;
                    categoryStats[book.category].borrowed += (book.totalCopies || 1) - (book.availableCopies || 0);
                }
            });
            
            // Create category cards
            Object.entries(categoryStats).forEach(([category, stats]) => {
                const card = document.createElement('div');
                card.className = 'book-card';
                card.style.cursor = 'pointer';
                card.onclick = () => viewCategoryBooks(category);
                
                card.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <div style="width: 60px; height: 60px; background: var(--primary); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; color: var(--secondary); font-size: 1.5rem;">
                            <span class="material-icons-sharp">category</span>
                        </div>
                        <div>
                            <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.25rem;">${category}</h3>
                            <p style="color: var(--text-secondary); font-size: 0.875rem;">${stats.total} books</p>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; text-align: center;">
                        <div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${stats.total}</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">Total</div>
                        </div>
                        <div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);">${stats.available}</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">Available</div>
                        </div>
                        <div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);">${stats.borrowed}</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">Borrowed</div>
                        </div>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        // View Category Books
        function viewCategoryBooks(category) {
            // Switch to books section and filter by category
            loadSection('books');
            setTimeout(() => {
                document.getElementById('categoryFilter').value = category;
                filterBooks();
            }, 100);
        }

        // Show Add Category Modal
        function showAddCategoryModal() {
            const template = document.getElementById('addCategoryModalTemplate');
            showModal(template.innerHTML);
        }

        // Add Category
        async function addCategory() {
            const name = document.getElementById('categoryName').value.trim();
            const description = document.getElementById('categoryDescription').value.trim();
            
            if (!name) {
                showAlert('Please enter category name', 'error');
                return;
            }
            
            // Add to categories array (in real app, would save to database)
            if (!categories.includes(name)) {
                categories.push(name);
                showAlert('Category added successfully', 'success');
                closeModal();
                loadSection('categories');
            } else {
                showAlert('Category already exists', 'error');
            }
        }

        // Load Reports
        function loadReports() {
            const template = document.getElementById('reportsTemplate');
            contentContainer.innerHTML = template.innerHTML;
            
            initReportsCharts();
            calculateReportStats();
            
            // Setup period change
            document.getElementById('reportPeriod').addEventListener('change', updateMonthlyStatsChart);
        }

        // Initialize Reports Charts
        function initReportsCharts() {
            initMonthlyStatsChart();
            initTopBorrowersChart();
        }

        // Initialize Monthly Stats Chart
        function initMonthlyStatsChart() {
            const ctx = document.getElementById('monthlyStatsChart').getContext('2d');
            
            if (charts.monthlyStatsChart) {
                charts.monthlyStatsChart.destroy();
            }
            
            const days = 30; // Default to last 30 days
            const labels = [];
            const borrowData = [];
            const returnData = [];
            
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(formatDateShort(date));
                
                const borrows = borrowRecords.filter(r => {
                    const borrowDate = new Date(r.borrowDate);
                    return borrowDate.toDateString() === date.toDateString();
                }).length;
                
                const returns = borrowRecords.filter(r => {
                    if (r.returnDate) {
                        const returnDate = new Date(r.returnDate);
                        return returnDate.toDateString() === date.toDateString();
                    }
                    return false;
                }).length;
                
                borrowData.push(borrows);
                returnData.push(returns);
            }
            
            charts.monthlyStatsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Borrows',
                            data: borrowData,
                            backgroundColor: 'rgba(212, 175, 55, 0.7)',
                            borderColor: 'rgb(212, 175, 55)',
                            borderWidth: 1
                        },
                        {
                            label: 'Returns',
                            data: returnData,
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            borderColor: 'rgb(59, 130, 246)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                drawBorder: false
                            },
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Update Monthly Stats Chart
        function updateMonthlyStatsChart() {
            const days = parseInt(document.getElementById('reportPeriod').value);
            
            const labels = [];
            const borrowData = [];
            const returnData = [];
            
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(formatDateShort(date));
                
                const borrows = borrowRecords.filter(r => {
                    const borrowDate = new Date(r.borrowDate);
                    return borrowDate.toDateString() === date.toDateString();
                }).length;
                
                const returns = borrowRecords.filter(r => {
                    if (r.returnDate) {
                        const returnDate = new Date(r.returnDate);
                        return returnDate.toDateString() === date.toDateString();
                    }
                    return false;
                }).length;
                
                borrowData.push(borrows);
                returnData.push(returns);
            }
            
            charts.monthlyStatsChart.data.labels = labels;
            charts.monthlyStatsChart.data.datasets[0].data = borrowData;
            charts.monthlyStatsChart.data.datasets[1].data = returnData;
            charts.monthlyStatsChart.update();
        }

        // Initialize Top Borrowers Chart
        function initTopBorrowersChart() {
            const ctx = document.getElementById('topBorrowersChart').getContext('2d');
            
            if (charts.topBorrowersChart) {
                charts.topBorrowersChart.destroy();
            }
            
            // Count borrows per user
            const userBorrowCounts = {};
            borrowRecords.forEach(record => {
                userBorrowCounts[record.userId] = (userBorrowCounts[record.userId] || 0) + 1;
            });
            
            // Get top 10 borrowers
            const topBorrowers = Object.entries(userBorrowCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const labels = topBorrowers.map(([userId]) => {
                const user = users.find(u => u.uid === userId);
                return user ? `${user.firstName} ${user.lastName.substring(0, 1)}.` : 'Unknown User';
            });
            
            const data = topBorrowers.map(([, count]) => count);
            
            charts.topBorrowersChart = new Chart(ctx, {
                type: 'horizontalBar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Books Borrowed',
                        data: data,
                        backgroundColor: 'rgba(212, 175, 55, 0.7)',
                        borderColor: 'rgb(212, 175, 55)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                drawBorder: false
                            },
                            ticks: {
                                stepSize: 1
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Calculate Report Stats
        function calculateReportStats() {
            // Most borrowed book
            const bookBorrowCounts = {};
            borrowRecords.forEach(record => {
                bookBorrowCounts[record.bookId] = (bookBorrowCounts[record.bookId] || 0) + 1;
            });
            
            let mostBorrowedBook = '-';
            let mostBorrowedCount = 0;
            
            Object.entries(bookBorrowCounts).forEach(([bookId, count]) => {
                if (count > mostBorrowedCount) {
                    const book = books.find(b => b.id === bookId);
                    if (book) {
                        mostBorrowedBook = book.title;
                        mostBorrowedCount = count;
                    }
                }
            });
            
            document.getElementById('mostBorrowedBook').textContent = mostBorrowedBook;
            document.getElementById('mostBorrowedBookChange').innerHTML = `<span>${mostBorrowedCount} borrows</span>`;
            
            // Average borrow duration
            const returnedBorrows = borrowRecords.filter(r => r.returnDate);
            if (returnedBorrows.length > 0) {
                const totalDays = returnedBorrows.reduce((sum, record) => {
                    const borrowDate = new Date(record.borrowDate);
                    const returnDate = new Date(record.returnDate);
                    return sum + Math.ceil((returnDate - borrowDate) / (1000 * 60 * 60 * 24));
                }, 0);
                
                const avgDays = Math.round(totalDays / returnedBorrows.length);
                document.getElementById('avgBorrowDuration').textContent = `${avgDays} days`;
            }
            
            // Busiest day
            const dayCounts = {};
            borrowRecords.forEach(record => {
                const date = new Date(record.borrowDate).toDateString();
                dayCounts[date] = (dayCounts[date] || 0) + 1;
            });
            
            let busiestDay = '-';
            let busiestCount = 0;
            
            Object.entries(dayCounts).forEach(([date, count]) => {
                if (count > busiestCount) {
                    busiestDay = new Date(date).toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
                    busiestCount = count;
                }
            });
            
            document.getElementById('busiestDay').textContent = busiestDay;
            document.getElementById('busiestDayChange').innerHTML = `<span>${busiestCount} borrows</span>`;
            
            // Total revenue from fines
            const totalRevenue = borrowRecords.reduce((sum, r) => sum + (r.fineAmount || 0), 0);
            document.getElementById('totalRevenue').textContent = `KSh ${totalRevenue}`;
        }

        // Generate Monthly Report
        function generateMonthlyReport() {
            const reportData = {
                generatedDate: new Date().toISOString(),
                period: 'Monthly Report',
                stats: {
                    totalBooks: books.length,
                    totalBorrows: borrowRecords.length,
                    activeBorrows: borrowRecords.filter(r => !r.returnDate).length,
                    overdueBorrows: borrowRecords.filter(r => {
                        if (!r.returnDate) {
                            const due = new Date(r.dueDate);
                            const today = new Date();
                            return due < today;
                        }
                        return false;
                    }).length,
                    totalFines: borrowRecords.reduce((sum, r) => sum + (r.fineAmount || 0), 0),
                    paidFines: borrowRecords.reduce((sum, r) => sum + (r.paid ? (r.fineAmount || 0) : 0), 0)
                },
                topBooks: books.sort((a, b) => (b.borrowCount || 0) - (a.borrowCount || 0)).slice(0, 10).map(book => ({
                    title: book.title,
                    author: book.author,
                    borrowCount: book.borrowCount || 0
                })),
                topUsers: users.map(user => {
                    const userBorrows = borrowRecords.filter(r => r.userId === user.uid);
                    return {
                        name: `${user.firstName} ${user.lastName}`,
                        email: user.email,
                        totalBorrows: userBorrows.length,
                        activeBorrows: userBorrows.filter(r => !r.returnDate).length
                    };
                }).sort((a, b) => b.totalBorrows - a.totalBorrows).slice(0, 10)
            };
            
            // Download as JSON
            downloadJSON(reportData, 'library_monthly_report.json');
            showAlert('Monthly report generated successfully', 'success');
        }

        // Generate Full Report
        function generateFullReport() {
            const reportData = {
                generatedDate: new Date().toISOString(),
                period: 'Full Library Report',
                libraryInfo: {
                    name: 'THE SONGA Library',
                    totalBooks: books.length,
                    totalUsers: users.length,
                    totalCategories: categories.length
                },
                detailedStats: {
                    byCategory: categories.reduce((acc, category) => {
                        const categoryBooks = books.filter(b => b.category === category);
                        acc[category] = {
                            total: categoryBooks.length,
                            available: categoryBooks.reduce((sum, b) => sum + (b.availableCopies || 0), 0),
                            borrowed: categoryBooks.reduce((sum, b) => sum + ((b.totalCopies || 1) - (b.availableCopies || 0)), 0)
                        };
                        return acc;
                    }, {}),
                    borrowingTrends: getLast30DaysTrends(),
                    userActivity: getUserActivityStats()
                },
                books: books.map(book => ({
                    title: book.title,
                    author: book.author,
                    category: book.category,
                    isbn: book.isbn,
                    copies: book.totalCopies,
                    available: book.availableCopies,
                    borrowCount: book.borrowCount || 0,
                    status: book.availability
                })),
                recentBorrows: borrowRecords
                    .sort((a, b) => new Date(b.borrowDate) - new Date(a.borrowDate))
                    .slice(0, 50)
                    .map(record => ({
                        bookTitle: record.bookTitle,
                        userName: record.userName,
                        borrowDate: record.borrowDate,
                        dueDate: record.dueDate,
                        returnDate: record.returnDate,
                        status: record.returnDate ? 'Returned' : 'Active',
                        fine: record.fineAmount || 0
                    }))
            };
            
            // Download as JSON
            downloadJSON(reportData, 'library_full_report.json');
            showAlert('Full report generated successfully', 'success');
        }

        // Get Last 30 Days Trends
        function getLast30DaysTrends() {
            const trends = [];
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                
                const borrows = borrowRecords.filter(r => {
                    const borrowDate = new Date(r.borrowDate);
                    return borrowDate.toDateString() === date.toDateString();
                }).length;
                
                const returns = borrowRecords.filter(r => {
                    if (r.returnDate) {
                        const returnDate = new Date(r.returnDate);
                        return returnDate.toDateString() === date.toDateString();
                    }
                    return false;
                }).length;
                
                trends.push({
                    date: date.toISOString().split('T')[0],
                    borrows: borrows,
                    returns: returns
                });
            }
            return trends;
        }

        // Get User Activity Stats
        function getUserActivityStats() {
            return users.map(user => {
                const userBorrows = borrowRecords.filter(r => r.userId === user.uid);
                return {
                    name: `${user.firstName} ${user.lastName}`,
                    email: user.email,
                    tier: user.membershipTier,
                    totalBorrows: userBorrows.length,
                    activeBorrows: userBorrows.filter(r => !r.returnDate).length,
                    overdueBorrows: userBorrows.filter(r => {
                        if (!r.returnDate) {
                            const due = new Date(r.dueDate);
                            const today = new Date();
                            return due < today;
                        }
                        return false;
                    }).length,
                    totalFines: userBorrows.reduce((sum, r) => sum + (r.fineAmount || 0), 0),
                    paidFines: userBorrows.reduce((sum, r) => sum + (r.paid ? (r.fineAmount || 0) : 0), 0)
                };
            });
        }

        // Download JSON
        function downloadJSON(data, filename) {
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', filename);
            linkElement.click();
        }

        // Load Settings
        async function loadSettings() {
            const template = document.getElementById('settingsTemplate');
            contentContainer.innerHTML = template.innerHTML;
            
            // Load saved settings
            await loadSavedSettings();
        }

        // Load Saved Settings
        async function loadSavedSettings() {
            try {
                const settingsSnapshot = await database.ref('systemSettings/library').once('value');
                if (settingsSnapshot.exists()) {
                    const savedSettings = settingsSnapshot.val();
                    
                    if (savedSettings.borrowDuration) document.getElementById('borrowDuration').value = savedSettings.borrowDuration;
                    if (savedSettings.dailyFine) document.getElementById('dailyFine').value = savedSettings.dailyFine;
                    if (savedSettings.maxRenewals) document.getElementById('maxRenewals').value = savedSettings.maxRenewals;
                    if (savedSettings.maxBooksPerUser) document.getElementById('maxBooksPerUser').value = savedSettings.maxBooksPerUser;
                    if (savedSettings.dueDateReminders !== undefined) document.getElementById('dueDateReminders').checked = savedSettings.dueDateReminders;
                    if (savedSettings.overdueNotifications !== undefined) document.getElementById('overdueNotifications').checked = savedSettings.overdueNotifications;
                    if (savedSettings.reservationNotifications !== undefined) document.getElementById('reservationNotifications').checked = savedSettings.reservationNotifications;
                    if (savedSettings.libraryName) document.getElementById('libraryName').value = savedSettings.libraryName;
                    if (savedSettings.libraryEmail) document.getElementById('libraryEmail').value = savedSettings.libraryEmail;
                    if (savedSettings.libraryAddress) document.getElementById('libraryAddress').value = savedSettings.libraryAddress;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Save Library Settings
        async function saveLibrarySettings() {
            const settings = {
                borrowDuration: parseInt(document.getElementById('borrowDuration').value) || 14,
                dailyFine: parseInt(document.getElementById('dailyFine').value) || 50,
                maxRenewals: parseInt(document.getElementById('maxRenewals').value) || 2,
                maxBooksPerUser: parseInt(document.getElementById('maxBooksPerUser').value) || 5,
                dueDateReminders: document.getElementById('dueDateReminders').checked,
                overdueNotifications: document.getElementById('overdueNotifications').checked,
                reservationNotifications: document.getElementById('reservationNotifications').checked,
                libraryName: document.getElementById('libraryName').value || 'THE SONGA Library',
                libraryEmail: document.getElementById('libraryEmail').value || 'library@thesongawelfare.com',
                libraryAddress: document.getElementById('libraryAddress').value || 'Nairobi, Kenya',
                updatedAt: new Date().toISOString()
            };
            
            try {
                await database.ref('systemSettings/library').set(settings);
                showAlert('Settings saved successfully', 'success');
            } catch (error) {
                console.error('Error saving settings:', error);
                showAlert('Failed to save settings', 'error');
            }
        }

        // Reset Settings
        function resetSettings() {
            if (confirm('Are you sure you want to reset all settings to default?')) {
                document.getElementById('borrowDuration').value = 14;
                document.getElementById('dailyFine').value = 50;
                document.getElementById('maxRenewals').value = 2;
                document.getElementById('maxBooksPerUser').value = 5;
                document.getElementById('dueDateReminders').checked = true;
                document.getElementById('overdueNotifications').checked = true;
                document.getElementById('reservationNotifications').checked = true;
                document.getElementById('libraryName').value = 'THE SONGA Library';
                document.getElementById('libraryEmail').value = 'library@thesongawelfare.com';
                document.getElementById('libraryAddress').value = 'Nairobi, Kenya';
                showAlert('Settings reset to default', 'info');
            }
        }

        // Export Books
        function exportBooks() {
            const exportData = books.map(book => ({
                Title: book.title,
                Author: book.author,
                ISBN: book.isbn || '',
                Category: book.category || '',
                'Total Copies': book.totalCopies || 1,
                'Available Copies': book.availableCopies || 0,
                'Borrow Count': book.borrowCount || 0,
                Status: book.availability || 'available',
                'Added Date': book.addedDate ? formatDate(book.addedDate) : '',
                Location: book.location || ''
            }));
            
            downloadCSV(exportData, 'books_export.csv');
            showAlert('Books exported successfully', 'success');
        }

        // Export Users
        function exportUsers() {
            const exportData = users.map(user => {
                const userBorrows = borrowRecords.filter(r => r.userId === user.uid);
                const activeBorrows = userBorrows.filter(r => !r.returnDate).length;
                const totalFines = userBorrows.reduce((sum, r) => sum + (r.fineAmount || 0), 0);
                
                return {
                    Name: `${user.firstName} ${user.lastName}`,
                    Email: user.email,
                    'Membership Tier': user.membershipTier || 'explorer',
                    Status: user.membershipStatus || 'active',
                    'Active Borrows': activeBorrows,
                    'Total Fines': `KSh ${totalFines}`,
                    'Joined Date': user.joinedDate ? formatDate(user.joinedDate) : ''
                };
            });
            
            downloadCSV(exportData, 'users_export.csv');
            showAlert('Users exported successfully', 'success');
        }

        // Download CSV
        function downloadCSV(data, filename) {
            if (data.length === 0) return;
            
            const headers = Object.keys(data[0]);
            const csvRows = [
                headers.join(','),
                ...data.map(row => headers.map(header => {
                    const cell = row[header] === null || row[header] === undefined ? '' : row[header];
                    return `"${cell.toString().replace(/"/g, '""')}"`;
                }).join(','))
            ];
            
            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', filename);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Show Modal
        function showModal(content) {
            modalOverlay.innerHTML = content;
            modalOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Close Modal
        function closeModal() {
            modalOverlay.classList.remove('active');
            modalOverlay.innerHTML = '';
            document.body.style.overflow = '';
            currentEditBookId = null;
            currentEditUserId = null;
        }

        // Show Confirmation Modal
        function showConfirmation(title, message, confirmCallback) {
            const template = document.getElementById('confirmationModalTemplate');
            showModal(template.innerHTML);
            
            setTimeout(() => {
                document.getElementById('confirmationTitle').textContent = title;
                document.getElementById('confirmationMessage').textContent = message;
                document.getElementById('confirmActionBtn').onclick = () => {
                    confirmCallback();
                    closeModal();
                };
            }, 100);
        }

        // Show Alert
        function showAlert(message, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <span class="material-icons-sharp" style="vertical-align: middle; margin-right: 0.5rem;">
                    ${type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'info'}
                </span>
                ${message}
            `;
            
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Format Date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Format Date Short
        function formatDateShort(date) {
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });
        }

        // Debounce Function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Search Data
        function searchData(query) {
            if (!query.trim()) {
                loadSection(currentSection);
                return;
            }
            
            // Implement search based on current section
            switch(currentSection) {
                case 'books':
                    document.getElementById('bookSearch').value = query;
                    filterBooks();
                    break;
                case 'users':
                    document.getElementById('userSearch').value = query;
                    filterUsers();
                    break;
                default:
                    // Global search logic for other sections
                    break;
            }
        }

        // Start Real-time Updates
        function startRealtimeUpdates() {
            // Listen for book changes
            database.ref('libraryBooks').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    books = Object.entries(snapshot.val()).map(([id, data]) => ({ id, ...data }));
                    
                    if (currentSection === 'books' || currentSection === 'overview') {
                        loadSection(currentSection);
                    }
                    
                    // Update categories
                    categories = [...new Set(books.map(book => book.category).filter(Boolean))];
                }
            });
            
            // Listen for borrow record changes
            database.ref('borrowRecords').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    borrowRecords = Object.values(snapshot.val());
                    
                    if (currentSection === 'borrow' || currentSection === 'returns' || currentSection === 'overview') {
                        loadSection(currentSection);
                    }
                }
            });
            
            // Listen for user changes
            database.ref('users').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    users = Object.values(snapshot.val());
                    
                    if (currentSection === 'users') {
                        loadSection(currentSection);
                    }
                }
            });
        }

        // Show Generate Report Modal
        function showGenerateReportModal() {
            // This would be a more advanced report generation modal
            // For now, just generate a simple report
            generateMonthlyReport();
        }

        // Show Return Book Modal
        function showReturnBookModal() {
            showReturnModal();
        }

        // Initialize Library Admin
        document.addEventListener('DOMContentLoaded', initializeLibraryAdmin);
    </script>
</body>
</html>
