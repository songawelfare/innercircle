<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.8, maximum-scale=1.0, user-scalable=no">
    <title>THE SONGA - Peer Community</title>
    <link rel="icon" type="image/x-icon" href="https://i.postimg.cc/BbdzCkxQ/20260116-0851-Elegant-Lion-Emblem-remix-01kf2npwbtf06ttr4htekjnd47-removebg-preview-2.webp">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase for Authentication ONLY -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBDZicoo7dFLtSmgRPvQE_gdm-tNOyCTXA",
            authDomain: "the-songa-77b1b.firebaseapp.com",
            projectId: "the-songa-77b1b",
            storageBucket: "the-songa-77b1b.firebasestorage.app",
            messagingSenderId: "123922889572",
            appId: "1:123922889572:web:482b2a624930baaf92d871"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        window.firebaseAuth = {
            auth,
            GoogleAuthProvider,
            signInWithPopup,
            signOut,
            onAuthStateChanged
        };
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        :root {
            --gold: #D4AF37;
            --gold-light: #F5E6B3;
            --gold-dark: #B8860B;
            --black: #000000;
            --white: #ffffff;
            --gray: #f5f5f5;
            --dark-gray: #333333;
            --light-gray: #e0e0e0;
            --card-bg: #ffffff;
            --border-color: #e1e8ed;
            --text-primary: #0f1419;
            --text-secondary: #536471;
            --like-red: #f91880;
            --retweet-green: #00ba7c;
            --comment-blue: #1d9bf0;
            --whatsapp-green: #25D366;
            --whatsapp-dark: #128C7E;
            --peer-blue: #3B82F6;
            --peer-purple: #8B5CF6;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            background-color: #f0f2f5;
            color: var(--text-primary);
            line-height: 1.6;
            padding-bottom: 70px;
        }

        /* Header */
        header {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 0.75rem 1rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--border-color);
            height: 60px;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 100%;
            max-width: 1000px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo img {
            height: 36px;
            width: 36px;
            border-radius: 50%;
            object-fit: cover;
        }

        .brand-name {
            font-weight: 700;
            font-size: 1.3rem;
            color: var(--gold-dark);
        }

        /* Peer Status */
        .peer-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--peer-blue);
            color: white;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .peer-status.offline {
            background: var(--light-gray);
            color: var(--text-secondary);
        }

        .peer-status i {
            font-size: 0.9rem;
        }

        /* Peer Connection Modal */
        .peer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .peer-modal.active {
            display: flex;
        }

        .peer-content {
            background-color: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .peer-header {
            background: linear-gradient(135deg, var(--peer-blue), var(--peer-purple));
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .peer-header h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .peer-body {
            padding: 2rem;
        }

        .peer-id-display {
            background: var(--gray);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .peer-id {
            font-family: monospace;
            font-size: 1.2rem;
            color: var(--peer-blue);
            word-break: break-all;
        }

        .peer-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .peer-btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .peer-btn.connect {
            background: var(--whatsapp-green);
            color: white;
        }

        .peer-btn.scan {
            background: var(--gold);
            color: var(--black);
        }

        .peer-btn.copy {
            background: var(--light-gray);
            color: var(--text-primary);
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            bottom: 70px;
            left: 0;
            right: 0;
            background: var(--whatsapp-green);
            color: white;
            padding: 10px;
            text-align: center;
            font-size: 0.9rem;
            z-index: 99;
            display: none;
        }

        .connection-status.show {
            display: block;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        /* Post Card - Peer Indicator */
        .post-card.peer-post {
            border: 2px solid var(--peer-blue);
            position: relative;
        }

        .peer-source {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--peer-blue);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .peer-source i {
            font-size: 0.8rem;
        }

        /* Post Availability */
        .post-availability {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid var(--peer-blue);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9rem;
            color: var(--peer-blue);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .post-availability i {
            font-size: 1rem;
        }

        /* Main Content */
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Create Post */
        .create-post-section {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .create-post-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 1.5rem;
        }

        .create-post-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid var(--gold);
            flex-shrink: 0;
        }

        .create-post-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .create-post-input {
            flex: 1;
        }

        .create-post-input textarea {
            width: 100%;
            border: none;
            font-size: 1.1rem;
            resize: none;
            min-height: 60px;
            padding: 12px;
            border-radius: 8px;
            background: #f7f9fa;
            color: var(--text-primary);
        }

        .create-post-input textarea:focus {
            outline: none;
            background: #eff1f2;
        }

        .post-privacy {
            display: flex;
            gap: 15px;
            margin-top: 1rem;
            padding: 10px;
            background: var(--gray);
            border-radius: 8px;
        }

        .privacy-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .privacy-option input {
            margin: 0;
        }

        /* Rest of your existing styles... */
        /* [Keep all your existing styles for posts, comments, etc.] */
    </style>
</head>
<body>
    <!-- Connection Status -->
    <div class="connection-status" id="connectionStatus">
        <i class="fas fa-wifi"></i> Connected to <span id="connectedPeerName"></span>
    </div>

    <!-- Peer Connection Modal -->
    <div class="peer-modal" id="peerModal">
        <div class="peer-content">
            <div class="peer-header">
                <h2>Connect with Peers</h2>
                <p>Share posts directly between devices</p>
            </div>
            <div class="peer-body">
                <div class="peer-id-display">
                    <div>Your Connection ID:</div>
                    <div class="peer-id" id="peerId">Generating...</div>
                </div>
                
                <div class="peer-actions">
                    <button class="peer-btn copy" id="copyPeerId">
                        <i class="fas fa-copy"></i> Copy Your ID
                    </button>
                    <button class="peer-btn connect" id="connectPeer">
                        <i class="fas fa-plug"></i> Connect to Peer
                    </button>
                    <button class="peer-btn scan" id="scanQR">
                        <i class="fas fa-qrcode"></i> Scan QR Code
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header>
        <div class="header-container">
            <div class="logo">
                <img src="https://i.postimg.cc/BbdzCkxQ/20260116-0851-Elegant-Lion-Emblem-remix-01kf2npwbtf06ttr4htekjnd47-removebg-preview-2.webp" alt="THE SONGA Logo">
                <div class="brand-name">THE SONGA</div>
            </div>
            
            <div class="auth-section">
                <button class="peer-status" id="peerStatusBtn">
                    <i class="fas fa-user-friends"></i>
                    <span id="peerCount">0</span> peers
                </button>
                
                <button class="create-post-btn" id="createPostBtnHeader" style="display: none;">
                    <i class="fas fa-feather-alt"></i>
                    <span>Post</span>
                </button>
                
                <div id="userProfile" class="user-profile" style="display: none;">
                    <div class="user-avatar">
                        <img id="userAvatar" src="" alt="User Avatar">
                    </div>
                    <div class="user-name" id="userDisplayName"></div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <!-- Peer Info Banner -->
        <div class="peer-info" style="background: linear-gradient(135deg, var(--peer-blue), var(--peer-purple)); color: white; padding: 12px; border-radius: 12px; margin-bottom: 1rem; text-align: center;">
            <i class="fas fa-sync-alt"></i>
            <strong>Peer-to-Peer Mode:</strong> Posts stay on owners' devices
        </div>

        <!-- Create Post -->
        <div class="create-post-section" id="createPostSection">
            <div class="create-post-header">
                <div class="create-post-avatar">
                    <img id="createPostAvatar" src="https://i.postimg.cc/BbdzCkxQ/20260116-0851-Elegant-Lion-Emblem-remix-01kf2npwbtf06ttr4htekjnd47-removebg-preview-2.webp" alt="Your Avatar">
                </div>
                <div class="create-post-input">
                    <textarea id="postContentInput" placeholder="Share something with connected peers..." maxlength="500"></textarea>
                </div>
            </div>
            
            <div class="post-privacy">
                <label class="privacy-option">
                    <input type="radio" name="postVisibility" value="connected" checked>
                    <i class="fas fa-user-friends"></i> Connected Peers
                </label>
                <label class="privacy-option">
                    <input type="radio" name="postVisibility" value="public">
                    <i class="fas fa-globe"></i> All Peers
                </label>
            </div>
            
            <div class="create-post-actions">
                <button class="post-submit" id="submitPostBtn" disabled>
                    <i class="fas fa-share-alt"></i> Share with Peers
                </button>
            </div>
        </div>

        <!-- Community Posts -->
        <div class="community-posts">
            <div class="posts-header">
                <h1 class="posts-title">
                    <i class="fas fa-users"></i>
                    Peer Feed
                    <span style="font-size: 0.8rem; color: var(--text-secondary); margin-left: 10px;">
                        <i class="fas fa-mobile-alt"></i> Local + Peer
                    </span>
                </h1>
            </div>

            <div id="postsContainer">
                <div class="loading-spinner" id="loadingSpinner">
                    <div class="spinner"></div>
                    <p>Loading local posts...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="#" class="nav-item active">
            <i class="fas fa-home nav-icon"></i>
            <span>Feed</span>
        </a>
        <a href="#" class="nav-item" id="peerConnectBtn">
            <i class="fas fa-user-friends nav-icon"></i>
            <span>Connect</span>
        </a>
        <a href="#" class="nav-item">
            <i class="fas fa-book nav-icon"></i>
            <span>Library</span>
        </a>
        <a href="#" class="nav-item">
            <i class="fas fa-user nav-icon"></i>
            <span>Profile</span>
        </a>
    </nav>

    <script>
        // Peer-to-Peer Social Network
        class PeerToPeerNetwork {
            constructor() {
                this.peer = null;
                this.connections = new Map(); // peerId -> connection
                this.peerData = new Map();    // peerId -> {name, avatar, posts}
                this.myPeerId = null;
                this.myData = {
                    name: 'Anonymous',
                    avatar: 'https://i.postimg.cc/BbdzCkxQ/20260116-0851-Elegant-Lion-Emblem-remix-01kf2npwbtf06ttr4htekjnd47-removebg-preview-2.webp',
                    posts: []
                };
                
                // Local storage for persistent data
                this.storage = {
                    get: (key) => JSON.parse(localStorage.getItem(`p2p_${key}`) || 'null'),
                    set: (key, value) => localStorage.setItem(`p2p_${key}`, JSON.stringify(value))
                };
            }
            
            async initialize(userData) {
                // Load saved data
                this.myData.name = userData.name;
                this.myData.avatar = userData.avatar;
                this.myData.posts = this.storage.get('my_posts') || [];
                
                // Initialize PeerJS (using a free signaling server)
                await this.initializePeer();
                
                // Load connected peers
                this.loadConnections();
                
                // Start listening for connections
                this.startListening();
            }
            
            async initializePeer() {
                // Generate a unique peer ID
                this.myPeerId = 'songa_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
                
                // Display peer ID
                document.getElementById('peerId').textContent = this.myPeerId;
                
                // Update peer count
                this.updatePeerCount();
            }
            
            startListening() {
                // In a real implementation, this would use WebRTC/PeerJS
                // For now, we'll simulate peer connections
                
                // Listen for incoming connections (simulated)
                window.addEventListener('peer-connect', (event) => {
                    const { peerId, peerName } = event.detail;
                    this.handleIncomingConnection(peerId, peerName);
                });
            }
            
            async connectToPeer(peerId, peerName = 'Unknown') {
                try {
                    console.log(`Connecting to peer: ${peerId}`);
                    
                    // Simulate connection
                    const connection = {
                        id: peerId,
                        name: peerName,
                        connected: true,
                        send: (data) => this.simulateDataTransfer(peerId, data),
                        close: () => this.disconnectPeer(peerId)
                    };
                    
                    this.connections.set(peerId, connection);
                    this.peerData.set(peerId, {
                        name: peerName,
                        avatar: 'https://i.postimg.cc/BbdzCkxQ/20260116-0851-Elegant-Lion-Emblem-remix-01kf2npwbtf06ttr4htekjnd47-removebg-preview-2.webp',
                        posts: []
                    });
                    
                    // Send my data to peer
                    this.sendToPeer(peerId, {
                        type: 'handshake',
                        data: {
                            name: this.myData.name,
                            avatar: this.myData.avatar,
                            peerId: this.myPeerId
                        }
                    });
                    
                    // Request peer's posts
                    this.sendToPeer(peerId, {
                        type: 'request_posts'
                    });
                    
                    this.updatePeerCount();
                    this.showConnectionStatus(`${peerName} connected`);
                    
                    return true;
                    
                } catch (error) {
                    console.error('Connection error:', error);
                    return false;
                }
            }
            
            simulateDataTransfer(peerId, data) {
                // Simulate network delay
                setTimeout(() => {
                    // In real implementation, this would send via WebRTC
                    // For now, just handle locally
                    this.handleIncomingData(peerId, data);
                }, 100);
            }
            
            handleIncomingConnection(peerId, peerName) {
                if (this.connections.has(peerId)) return;
                
                this.connectToPeer(peerId, peerName);
            }
            
            handleIncomingData(peerId, data) {
                console.log(`Received from ${peerId}:`, data);
                
                switch(data.type) {
                    case 'handshake':
                        this.handleHandshake(peerId, data.data);
                        break;
                    case 'post':
                        this.handleNewPost(peerId, data.data);
                        break;
                    case 'request_posts':
                        this.sendMyPosts(peerId);
                        break;
                    case 'posts':
                        this.handleReceivedPosts(peerId, data.data);
                        break;
                    case 'like':
                        this.handleLike(peerId, data.data);
                        break;
                    case 'comment':
                        this.handleComment(peerId, data.data);
                        break;
                }
            }
            
            handleHandshake(peerId, data) {
                // Update peer info
                if (this.peerData.has(peerId)) {
                    this.peerData.get(peerId).name = data.name;
                    this.peerData.get(peerId).avatar = data.avatar;
                }
            }
            
            createPost(content, visibility = 'connected') {
                const post = {
                    id: 'post_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    authorId: this.myPeerId,
                    authorName: this.myData.name,
                    authorAvatar: this.myData.avatar,
                    content: content,
                    likes: 0,
                    comments: [],
                    createdAt: new Date().toISOString(),
                    visibility: visibility,
                    likesBy: [],
                    sharedWith: [] // Track which peers have this post
                };
                
                // Save locally
                this.myData.posts.unshift(post);
                this.storage.set('my_posts', this.myData.posts);
                
                // Share with connected peers
                if (visibility === 'connected' || visibility === 'public') {
                    this.sharePostWithPeers(post);
                }
                
                return post;
            }
            
            sharePostWithPeers(post) {
                // Share with all connected peers
                this.connections.forEach((connection, peerId) => {
                    this.sendToPeer(peerId, {
                        type: 'post',
                        data: post
                    });
                });
            }
            
            sendToPeer(peerId, data) {
                const connection = this.connections.get(peerId);
                if (connection && connection.connected) {
                    connection.send(data);
                }
            }
            
            handleNewPost(peerId, post) {
                // Store post from peer
                if (!this.peerData.has(peerId)) return;
                
                const peer = this.peerData.get(peerId);
                if (!peer.posts.find(p => p.id === post.id)) {
                    peer.posts.unshift(post);
                    this.triggerPostUpdate();
                }
            }
            
            sendMyPosts(peerId) {
                const myPublicPosts = this.myData.posts.filter(post => 
                    post.visibility === 'connected' || post.visibility === 'public'
                );
                
                this.sendToPeer(peerId, {
                    type: 'posts',
                    data: myPublicPosts
                });
            }
            
            handleReceivedPosts(peerId, posts) {
                if (!this.peerData.has(peerId)) return;
                
                const peer = this.peerData.get(peerId);
                // Add new posts only
                posts.forEach(post => {
                    if (!peer.posts.find(p => p.id === post.id)) {
                        peer.posts.push(post);
                    }
                });
                
                // Sort by date
                peer.posts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                this.triggerPostUpdate();
            }
            
            likePost(postId, authorPeerId) {
                // Find the post (could be mine or peer's)
                let post = null;
                let isMyPost = false;
                
                // Check my posts
                post = this.myData.posts.find(p => p.id === postId);
                if (post) {
                    isMyPost = true;
                } else {
                    // Check peer posts
                    this.peerData.forEach((peer, peerId) => {
                        const found = peer.posts.find(p => p.id === postId);
                        if (found) {
                            post = found;
                            authorPeerId = peerId;
                        }
                    });
                }
                
                if (!post) return;
                
                // Update like count
                post.likes = (post.likes || 0) + 1;
                if (!post.likesBy) post.likesBy = [];
                post.likesBy.push(this.myPeerId);
                
                // Save if it's my post
                if (isMyPost) {
                    this.storage.set('my_posts', this.myData.posts);
                }
                
                // Notify author if it's not my post
                if (!isMyPost && authorPeerId && this.connections.has(authorPeerId)) {
                    this.sendToPeer(authorPeerId, {
                        type: 'like',
                        data: { postId, likedBy: this.myPeerId }
                    });
                }
                
                this.triggerPostUpdate();
            }
            
            handleLike(peerId, data) {
                // Someone liked my post
                const post = this.myData.posts.find(p => p.id === data.postId);
                if (post) {
                    post.likes = (post.likes || 0) + 1;
                    if (!post.likesBy) post.likesBy = [];
                    post.likesBy.push(peerId);
                    this.storage.set('my_posts', this.myData.posts);
                    this.triggerPostUpdate();
                }
            }
            
            addComment(postId, content, authorPeerId) {
                // Similar to like, but for comments
                // Implementation would be similar to like functionality
            }
            
            disconnectPeer(peerId) {
                if (this.connections.has(peerId)) {
                    this.connections.delete(peerId);
                    this.updatePeerCount();
                    this.showNotification(`Disconnected from peer`, 'info');
                }
            }
            
            updatePeerCount() {
                const count = this.connections.size;
                document.getElementById('peerCount').textContent = count;
                
                // Update status button
                const statusBtn = document.getElementById('peerStatusBtn');
                statusBtn.className = `peer-status ${count === 0 ? 'offline' : ''}`;
            }
            
            triggerPostUpdate() {
                // Trigger UI update
                window.dispatchEvent(new CustomEvent('posts-updated'));
            }
            
            showConnectionStatus(message) {
                const statusEl = document.getElementById('connectionStatus');
                statusEl.classList.add('show');
                statusEl.innerHTML = `<i class="fas fa-wifi"></i> ${message}`;
                
                setTimeout(() => {
                    statusEl.classList.remove('show');
                }, 3000);
            }
            
            saveConnections() {
                const connections = Array.from(this.connections.keys());
                this.storage.set('connections', connections);
            }
            
            loadConnections() {
                const savedConnections = this.storage.get('connections') || [];
                savedConnections.forEach(peerId => {
                    // In real implementation, you'd reconnect here
                    console.log('Would reconnect to:', peerId);
                });
            }
            
            getAllPosts() {
                const allPosts = [];
                
                // Add my posts
                this.myData.posts.forEach(post => {
                    allPosts.push({
                        ...post,
                        source: 'me',
                        available: true
                    });
                });
                
                // Add peer posts
                this.peerData.forEach((peer, peerId) => {
                    peer.posts.forEach(post => {
                        allPosts.push({
                            ...post,
                            source: 'peer',
                            peerId: peerId,
                            peerName: peer.name,
                            available: this.connections.has(peerId) // Only available if connected
                        });
                    });
                });
                
                // Sort by date
                return allPosts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            }
            
            // Simulated peer connection for demo
            simulatePeerConnection() {
                const simulatedPeers = [
                    { id: 'songa_peer_1', name: 'Alice' },
                    { id: 'songa_peer_2', name: 'Bob' },
                    { id: 'songa_peer_3', name: 'Charlie' }
                ];
                
                // Randomly connect to a simulated peer
                const randomPeer = simulatedPeers[Math.floor(Math.random() * simulatedPeers.length)];
                this.connectToPeer(randomPeer.id, randomPeer.name);
                
                // Simulate receiving a post from peer
                setTimeout(() => {
                    const simulatedPost = {
                        id: 'peer_post_' + Date.now(),
                        authorId: randomPeer.id,
                        authorName: randomPeer.name,
                        authorAvatar: 'https://i.postimg.cc/BbdzCkxQ/20260116-0851-Elegant-Lion-Emblem-remix-01kf2npwbtf06ttr4htekjnd47-removebg-preview-2.webp',
                        content: `Hello from ${randomPeer.name}! This is a simulated peer post. The data stays on my device but you can view it while we're connected.`,
                        likes: 3,
                        comments: [],
                        createdAt: new Date().toISOString(),
                        visibility: 'public'
                    };
                    
                    this.handleNewPost(randomPeer.id, simulatedPost);
                }, 1000);
            }
        }

        // Main Application
        class THE_SONGA_P2P_App {
            constructor() {
                this.network = new PeerToPeerNetwork();
                this.currentUser = null;
                this.initializeApp();
            }
            
            async initializeApp() {
                this.setupEventListeners();
                this.checkAuthState();
                this.setupPeerListeners();
            }
            
            setupEventListeners() {
                // Peer connection button
                document.getElementById('peerConnectBtn').addEventListener('click', () => {
                    document.getElementById('peerModal').classList.add('active');
                });
                
                // Copy peer ID
                document.getElementById('copyPeerId').addEventListener('click', () => {
                    navigator.clipboard.writeText(document.getElementById('peerId').textContent);
                    this.showNotification('Peer ID copied!', 'success');
                });
                
                // Connect to peer
                document.getElementById('connectPeer').addEventListener('click', () => {
                    const peerId = prompt('Enter peer ID to connect:');
                    if (peerId) {
                        this.network.connectToPeer(peerId);
                    }
                });
                
                // Simulate connection for demo
                document.getElementById('scanQR').addEventListener('click', () => {
                    this.network.simulatePeerConnection();
                    this.showNotification('Simulated peer connected!', 'success');
                    document.getElementById('peerModal').classList.remove('active');
                });
                
                // Create post
                document.getElementById('submitPostBtn').addEventListener('click', () => this.createPost());
                
                // Post content input
                document.getElementById('postContentInput').addEventListener('input', (e) => {
                    document.getElementById('submitPostBtn').disabled = e.target.value.trim().length === 0;
                });
            }
            
            setupPeerListeners() {
                // Listen for post updates
                window.addEventListener('posts-updated', () => {
                    this.renderPosts();
                });
            }
            
            async checkAuthState() {
                // Load saved user or create local user
                const savedUser = JSON.parse(localStorage.getItem('the_songa_user') || 'null');
                
                if (savedUser) {
                    this.currentUser = savedUser;
                    this.initializeNetwork();
                } else {
                    // Create local user
                    this.createLocalUser();
                }
            }
            
            createLocalUser() {
                this.currentUser = {
                    id: 'local_' + Date.now(),
                    name: 'Local User',
                    avatar: 'https://i.postimg.cc/BbdzCkxQ/20260116-0851-Elegant-Lion-Emblem-remix-01kf2npwbtf06ttr4htekjnd47-removebg-preview-2.webp'
                };
                
                localStorage.setItem('the_songa_user', JSON.stringify(this.currentUser));
                this.initializeNetwork();
            }
            
            async initializeNetwork() {
                // Update UI
                document.getElementById('userAvatar').src = this.currentUser.avatar;
                document.getElementById('userDisplayName').textContent = this.currentUser.name;
                document.getElementById('createPostAvatar').src = this.currentUser.avatar;
                document.getElementById('userProfile').style.display = 'flex';
                document.getElementById('createPostBtnHeader').style.display = 'flex';
                
                // Initialize P2P network
                await this.network.initialize(this.currentUser);
                
                // Load posts
                this.renderPosts();
            }
            
            async createPost() {
                const content = document.getElementById('postContentInput').value.trim();
                if (!content || !this.currentUser) return;
                
                const visibility = document.querySelector('input[name="postVisibility"]:checked').value;
                const post = this.network.createPost(content, visibility);
                
                // Clear input
                document.getElementById('postContentInput').value = '';
                document.getElementById('submitPostBtn').disabled = true;
                
                this.showNotification('Post created and shared with peers!', 'success');
                this.renderPosts();
            }
            
            renderPosts() {
                const postsContainer = document.getElementById('postsContainer');
                const posts = this.network.getAllPosts();
                
                if (posts.length === 0) {
                    postsContainer.innerHTML = `
                        <div class="no-posts">
                            <div class="no-posts-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                            <h3>No posts yet</h3>
                            <p>Create a post to share with connected peers!</p>
                            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 1rem;">
                                <i class="fas fa-info-circle"></i>
                                Connect with peers to see their posts
                            </p>
                        </div>
                    `;
                    return;
                }
                
                postsContainer.innerHTML = posts.map(post => this.renderPost(post)).join('');
                this.attachPostEventListeners();
            }
            
            renderPost(post) {
                const isAvailable = post.available !== false;
                const isMyPost = post.source === 'me';
                const likeCount = post.likes || 0;
                const commentCount = (post.comments || []).length;
                
                return `
                    <div class="post-card ${isMyPost ? '' : 'peer-post'}" data-post-id="${post.id}" data-author-id="${post.authorId}">
                        ${!isMyPost ? `
                            <div class="peer-source">
                                <i class="fas fa-user-friends"></i> From ${post.peerName || 'Peer'}
                            </div>
                        ` : ''}
                        
                        <div class="post-header">
                            <div class="post-avatar">
                                <img src="${post.authorAvatar}" alt="${post.authorName}">
                            </div>
                            <div class="post-author-info">
                                <div class="post-author">
                                    ${post.authorName}
                                    ${isMyPost ? '<i class="fas fa-user"></i>' : '<i class="fas fa-user-friends"></i>'}
                                </div>
                                <div class="post-time">${this.formatTimeAgo(post.createdAt)}</div>
                            </div>
                        </div>
                        
                        <div class="post-content">
                            ${this.formatContent(post.content)}
                        </div>
                        
                        ${!isAvailable ? `
                            <div class="post-availability">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>Post unavailable (peer disconnected)</span>
                            </div>
                        ` : ''}
                        
                        <div class="post-stats">
                            <div class="post-stat">
                                <i class="fas fa-heart"></i>
                                <span>${likeCount} likes</span>
                            </div>
                            <div class="post-stat">
                                <i class="fas fa-comment"></i>
                                <span>${commentCount} comments</span>
                            </div>
                            <div class="post-stat">
                                <i class="fas fa-share"></i>
                                <span>Shared with peers</span>
                            </div>
                        </div>
                        
                        ${isAvailable ? `
                            <div class="post-actions">
                                <button class="post-action like" data-action="like" data-post-id="${post.id}">
                                    <i class="fas fa-heart action-icon"></i>
                                    <span class="action-count">${likeCount}</span>
                                </button>
                                <button class="post-action comment" data-action="comment" data-post-id="${post.id}">
                                    <i class="fas fa-comment action-icon"></i>
                                    <span class="action-count">${commentCount}</span>
                                </button>
                                <button class="post-action share" data-action="share" data-post-id="${post.id}">
                                    <i class="fas fa-share-alt action-icon"></i>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            attachPostEventListeners() {
                // Like buttons
                document.querySelectorAll('[data-action="like"]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const postId = e.currentTarget.dataset.postId;
                        const authorId = e.currentTarget.closest('.post-card').dataset.authorId;
                        this.network.likePost(postId, authorId);
                    });
                });
                
                // Share buttons
                document.querySelectorAll('[data-action="share"]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const postId = e.currentTarget.dataset.postId;
                        this.sharePost(postId);
                    });
                });
            }
            
            sharePost(postId) {
                // Get post
                const posts = this.network.getAllPosts();
                const post = posts.find(p => p.id === postId);
                
                if (!post) return;
                
                const shareText = `THE SONGA Peer Post: "${post.content.substring(0, 100)}..."\n\nShared via peer-to-peer network`;
                
                if (navigator.share) {
                    navigator.share({
                        title: 'THE SONGA Peer Post',
                        text: shareText,
                        url: window.location.href
                    });
                } else {
                    // Copy to clipboard
                    navigator.clipboard.writeText(shareText)
                        .then(() => this.showNotification('Post copied to share!', 'success'))
                        .catch(() => this.showNotification('Error sharing post', 'error'));
                }
            }
            
            formatContent(content) {
                // Convert URLs to links
                let formatted = content.replace(
                    /(https?:\/\/[^\s]+)/g,
                    '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
                );
                
                // Convert hashtags
                formatted = formatted.replace(
                    /#(\w+)/g,
                    '<a href="#" class="hashtag">#$1</a>'
                );
                
                // Convert newlines to <br>
                formatted = formatted.replace(/\n/g, '<br>');
                
                return formatted;
            }
            
            formatTimeAgo(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const seconds = Math.floor((now - date) / 1000);
                
                if (seconds < 60) return 'Just now';
                if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
                if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
                if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
                
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
            
            showNotification(message, type = 'info') {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `notification show ${type}`;
                notification.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new THE_SONGA_P2P_App();
        });
    </script>
</body>
</html>
